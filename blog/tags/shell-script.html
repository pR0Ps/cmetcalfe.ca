<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts tagged with 'shell script' on this site">

  <link rel="stylesheet" type="text/css" href="../../theme/css/styles.ec0bdb0f.min.css">

  <script src="../../theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />


  <title>Tag: shell script | Carey Metcalfe</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28306875-1', 'cmetcalfe.ca');
  ga('send', 'pageview');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="../..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href="../.." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="../..">Home</a>

      &#124; <a href="../../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>Tag: shell script
</p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="../../blog/remove-proxmox-subscription-notice.html">Removing the Proxmox VE subscription notice</a></h1>
  </div>
  <div class="article_text">
    <p><a href="https://www.proxmox.com/proxmox-ve">Proxmox VE</a> is an open-source (<a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL v3</a>) virtualization platform for running containers and
VMs. It's comparable to a proprietary solution like <a href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a>.</p>
<p>It can be downloaded and installed completely free of charge, lacking only access to support and
other things that more enterprise-focused users care about. For a homelab install, the free version
is perfect.</p>
<p>...except for one thing. Each time you log in, you have to click through this dialog:</p>
<p><img alt="&quot;You do not have a valid subscription for this server. Please visit www.proxmox.com to get a list of available options.&quot;" src="../../images/proxmox_subscription_notice.png"></p>
<p>The goal of this post is to walk through developing a solution to automatically remove that
notification in any installed version of Proxmox VE, as well as have that removal survive future
updates.</p>
<p><strong>To skip to the solution, click <a href="#the-solution">here</a>.</strong></p>
<h1>Developing a patch</h1>
<p>Searching the internet reveals that a few other people (<a href="https://johnscs.com/remove-proxmox51-subscription-notice/">1</a>, <a href="https://dannyda.com/2020/05/17/how-to-remove-you-do-not-have-a-valid-subscription-for-this-server-from-proxmox-virtual-environment-6-1-2-proxmox-ve-6-1-2-pve-6-1-2/">2</a>, <a href="https://www.jamescoyle.net/how-to/614-remove-the-proxmox-no-subscription-message">3</a>) have already attacked
this problem. All articles point to some code in
<code>/usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</code> being responsible for the notification
so this is where we'll start.</p>
<p>Scanning though that file reveals a function called <a href="https://git.proxmox.com/?p=proxmox-widget-toolkit.git;a=blob;f=src/Utils.js;h=85387946165e592e89a65e6973dc7f1836edc984;hb=HEAD#l460"><code>checked_command(orig_cmd)</code></a>.
This function just executes <code>orig_cmd</code> after showing the subscription notification if it determines
that you don't have a valid subscription.</p>
<p>Based on this, the goal of this patch will be to make <code>checked_command</code> always execute <code>orig_cmd</code>
without bothering to check if there is a subscription at all. As a bonus, this will also speed up
the login process since it removes a blocking call to the server<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>.</p>
<p>Since we want this patch to work for as many versions as possible, it's a good idea to take a look
into how this function has changed over time. By looking at the <a href="https://git.proxmox.com/?p=proxmox-widget-toolkit.git">proxmox-widget-toolkit</a> history,
we can see that <code>checked_command</code> was originally added in commit <a href="https://git.proxmox.com/?p=proxmox-widget-toolkit.git;a=commitdiff;h=5f93e010854dadb38fa1e7d10c00f42df38cedd4"><code>5f93e010</code></a>. However, it
was actually moved from the <a href="https://git.proxmox.com/?p=pve-manager.git;">pve-manager</a> project where it was written for the <a href="https://git.proxmox.com/?p=pve-manager.git;a=commitdiff;h=1556735e9c4dfdd13d1b0823942adf8feb003891">initial
implementation of the subscription notice</a>. By looking at the entire history of this function we can see that
while the function implementation has changed slightly over time, the name, arguments, and goal of
it has stayed exactly the same.</p>
<p>Given this, as long as we only use the function definition to do the patch, it should work for every
version of Proxmox VE to date (and hopefully into the future). Using <code>sed</code> to prepend <code>orig_cmd();
return;</code> to the function should work nicely:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sed --in-place <span class="s1">&#39;s/checked_command: function(orig_cmd) {$/&amp; orig_cmd(); return;/&#39;</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
</code></pre></div></td></tr></table></div>

<p>This results in the following change:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gd">-checked_command: function(orig_cmd) {</span><span class="w"></span>
<span class="gi">+checked_command: function(orig_cmd) { orig_cmd(); return;</span><span class="w"></span>
</code></pre></div></td></tr></table></div>

<p>Notice that the <code>sed</code> script is looking for the function definition followed by a line ending (<code>$</code>).
Because the patch is added to the same line, if the command is run again it won't match and won't
make any changes, making it safe to blindly run multiple times. This becomes important for
automating it later.</p>
<p>Now that we know it works, we should harden it up against whitespace changes by replacing the spaces
in the regex with <code>\s*</code> (0 or more whitespace characters):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sed --in-place <span class="s1">&#39;s/checked_command:\s*function(orig_cmd)\s*{\s*$/&amp; orig_cmd(); return;/&#39;</span> /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
</code></pre></div></td></tr></table></div>

<p>The only thing left to solve is which file <code>checked_command</code> is defined in. Since it used to be a
part of the <code>pve-manager</code> project, it's safe to say that it wasn't always stored in
<code>/usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</code>. It could also move around in the
future.</p>
<p>To deal with this, we use <code>grep</code> to find the file that it's defined in, then run the previous
command over that file:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>grep --files-with-matches --include <span class="s1">&#39;*.js&#39;</span> --recursive --null <span class="s1">&#39;checked_command:\s*function(orig_cmd)&#39;</span> /usr/share/ <span class="se">\</span>
  <span class="p">|</span> xargs --null --no-run-if-empty sed --in-place <span class="s1">&#39;s/checked_command:\s*function(orig_cmd)\s*{\s*$/&amp; orig_cmd(); return;/&#39;</span>
</code></pre></div></td></tr></table></div>

<p>Simply run this command on your Proxmox VE server<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>, refresh the web UI, and the notice should be
gone!</p>
<h1>Automating it</h1>
<p>At this point we have a working command that will remove the subscription notice from any version of
Proxmox VE to date. However, after updating the system, there's a chance that a newer version of the
file will have overwritten our patched version.</p>
<p>While we could just save the command in a script and manually run it after every update, that's
annoying and will definitely be forgotten. Instead, we want to automatically run the command every
time the web server starts. This will ensure that it will always be serving a patched version of the
file.</p>
<p>Proxmox VE uses <a href="https://systemd.io/"><code>systemd</code></a> to manage the startup of its services. This means that once we
find the service that manages the web server, we should be able to make <code>systemd</code> launch a service
that applies our patch just before the web server.</p>
<p>The first step is to find the service that manages the web server. Since we know it's running on
port 8006, we can use <code>netstat</code> to enumerate all listening TCP ports and <code>grep</code> to filter it down to
just the port we're interested in:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>$ netstat --listening --tcp --numeric-ports --program <span class="p">|</span> grep <span class="m">8006</span>
tcp  <span class="m">0</span>  <span class="m">0</span>  <span class="m">0</span>.0.0.0:8006  <span class="m">0</span>.0.0.0:*  LISTEN  <span class="m">15771</span>/pveproxy
</code></pre></div></td></tr></table></div>

<p>Once we know the PID of the program, running <code>systemctl status &lt;PID&gt;</code> will show the status
(including the service name) of the service that's managing it<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>. In this case it shows that the
service is <code>pveproxy.service</code>.</p>
<p>We can now define a service that runs our code, is wanted by <code>pveproxy.service</code>, and
must be run before it. Then, whenever <code>systemd</code> starts (or restarts) <code>pveproxy.service</code>, it will
make sure to also run our service that applies the patch.</p>
<h1>The solution</h1>
<p><a name="the-solution"></a>
Putting it all together:</p>
<p>1. Create <code>/etc/systemd/system/no-subscription-notice.service</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">Remove Proxmox VE subscription notice</span><span class="w"></span>
<span class="na">Before</span><span class="o">=</span><span class="s">pveproxy.service</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span><span class="w"></span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/sh -c &quot;grep --files-with-matches --include &#39;*.js&#39; --recursive --null &#39;checked_command:\s*function(orig_cmd)&#39; /usr/share/ | xargs --null --no-run-if-empty sed --in-place &#39;s/checked_command:\s*function(orig_cmd)\s*{\s*$/&amp; orig_cmd(); return;/&#39;&quot;</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">pveproxy.service</span><span class="w"></span>
</code></pre></div></td></tr></table></div>

<p>2. <code>systemctl enable --now no-subscription-notice.service</code></p>
<p>And that's it! The subscription notice should now be gone for good. I'll update this post if it
breaks, but that hopefully won't be for a while.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>Interestingly, the existing solutions I found all patch the code that checks the returned
    subscription status instead of just not asking about the status at all. Compared to the
    solution here, this is both more fragile, as well as slower.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Commands can be run from the web UI (Datacenter -&gt; node -&gt; Shell), via SSH, or just by
    using a keyboard and monitor hooked up to the server.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Another way to go from PID or command to service name is to use <code>ps</code> like so:
    <code>ps --format=unit= &lt;PID&gt;</code> or <code>ps --format=unit= -C &lt;cmd&gt;</code>. Note that this requires your
    version of <code>ps</code> to be compiled with <code>systemd</code> support (which it is in most <code>systemd</code>-based
    distros).&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../../blog/prevent-auto-lock-by-simulating-activity.html">Preventing auto-locking and sleeping by simulating user activity</a></h1>
  </div>
  <div class="article_text">
    <p>This post will detail how to simulate activity on your computer in order to prevent it from
auto-locking or going into sleep mode. Note that this will usually also prevent the "auto-away"
functionality of various chat programs from ever marking you as "away".</p>
<p>Generally you should change your operating system's settings to disable sleeping and auto-locking if
possible instead. These methods are for when you don't have the access or permission to change those
settings (ie. locked-down devices).</p>
<h2>Windows</h2>
<p>This method runs a <a href="https://en.wikipedia.org/wiki/Powershell">Powershell</a> script on login that toggles <a href="https://en.wikipedia.org/wiki/Scroll_lock">scroll lock</a> on/off every minute.
Since scroll lock mostly doesn't do anything on modern systems and the script will press it twice to
immediately unlock/relock it, this is basically unnoticeable to the user. However, if you have
issues simply swap the two <code>{SCROLLLOCK}</code>s in the below command to something else. A full list of
special keys can be found <a href="https://social.technet.microsoft.com/wiki/contents/articles/5169.vbscript-sendkeys-method.aspx">here</a>.</p>
<ol>
<li>Open Explorer (shortcut: <code>Win+E</code>)</li>
<li>Paste <code>%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup</code> into the location bar and hit
   enter to navigate there.</li>
<li>Right click in the folder and click <code>New &gt; Shortcut</code> to open the shortcut creation wizard.</li>
<li>
<p>Paste the following as the shortcut's location:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>powershell.exe -windowstyle hidden -command &quot;$myshell=New-Object -com \&quot;Wscript.Shell\&quot;;while(1){$myshell.SendKeys(\&quot;{SCROLLLOCK}{SCROLLLOCK}\&quot;);Start-Sleep -Seconds 60}&quot;
</code></pre></div></td></tr></table></div>

</li>
<li>
<p>Give it any name you like and hit <code>Finish</code></p>
</li>
</ol>
<h2>macOS</h2>
<p>This method runs a shell script on login that uses a tool called <a href="https://www.bluem.net/en/projects/cliclick/"><code>cliclick</code></a> to move the
mouse one pixel left and right every minute. This is such a small and fast movement that it's
usually not noticeable unless you're really looking for it.</p>
<ol>
<li>Install <code>cliclick</code> from <a href="https://www.bluem.net/en/projects/cliclick/">the project website</a> or via <a href="https://brew.sh/">brew</a> (<code>brew install cliclick</code>)</li>
<li>Create a script called <code>jiggle</code> with the following contents:</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>#!/bin/sh
while true; do
    cliclick &#39;m:-1,+0&#39; &#39;m:+1,+0&#39;
    sleep 60
done
</code></pre></div></td></tr></table></div>

<ol>
<li>Make the script executable (<code>chmod +x jiggle</code>)</li>
<li>Open System Preferences, search for "login items" and hit enter.</li>
<li>Click the <code>+</code> button, select the <code>jiggle</code> script and hit "Add". You should see it appear in the
   list of programs as a "Unix executable". Check the "Hide" checkbox beside it and exit.</li>
</ol>
<h2>Xorg-based Linux</h2>
<p>Much like the macOS version above, this moves the mouse one pixel left and right every minute. If
you would prefer to instead use a keyboard-based method like the above Windows version, use <code>xdotool
key Scroll_Lock</code> twice instead of the <code>xdotool mousemove_relative *</code> commands in the following
script. More special key names for <code>xdotool</code> can be found <a href="https://gitlab.com/cunidev/gestures/-/wikis/xdotool-list-of-key-codes">here</a>.</p>
<ol>
<li>Install <a href="https://www.semicomplete.com/projects/xdotool/"><code>xdotool</code></a> (usually available via your package manager)</li>
<li>Create a script called <code>jiggle</code> with the following contents:</li>
</ol>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code>#!/bin/sh
while true; do
    xdotool mousemove_relative --sync -- -1 0
    xdotool mousemove_relative 1 0
    sleep 60
done
</code></pre></div></td></tr></table></div>

<ol>
<li>Make the script executable (<code>chmod +x jiggle</code>)</li>
<li>Configure your OS to run the script at login. Usually this would be done through the desktop
   environment's settings or via something like <a href="https://www.freedesktop.org/wiki/Software/systemd/"><code>systemd</code></a>.</li>
</ol>
<h2>Wayland-based Linux</h2>
<p>Some preliminary research suggests that this is possible on Wayland using <a href="https://github.com/ReimuNotMoe/ydotool"><code>ydotool</code></a> as a
replacement for <code>xdotool</code>. I don't currently run a Wayland-based setup so I can't test it. If you
manage to find a solution for Wayland feel free to send it to me and I'll update the post.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../../blog/proxied-access-to-namecheap-dns.html">Proxied access to the Namecheap DNS API</a></h1>
  </div>
  <div class="article_text">
    <h2>Background</h2>
<p>Both this site and my home server use HTTPS certificates provided by <a href="https://letsencrypt.org">Let's Encrypt</a>.
<a href="../../blog/adding-https-support.html">Previously</a> I was using the <code>http-01</code> challenge method, but once <a href="https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579">wildcard
certificates became available</a>, I decided to switch to the <code>dns-01</code> method for simplicity.</p>
<p>My domains are currently registered through <a href="https://www.namecheap.com/">Namecheap</a> which provides an API for modifying DNS
records. The only catch is that it can only be accessed via manually-whitelisted IP addresses.
Because the server I'm trying to access the API from is assigned a dynamic IP, this restriction was
a bit of an issue.</p>
<p>Back in November when I initially made the switch to the DNS-based challenge, I set it up the easy
way: I manually added my current IP to the whitelist, added a TODO entry to fix it somehow, and set
a reminder scheduled for the week before the cert would expire telling me to update the IP
whitelist. Fast-forward to today when I was reminded to update my IP whitelist. Instead of
continuing to kick the can down the road, I decided to actually fix the issue.</p>
<h2>Setting up a temporary proxy</h2>
<p>My home server is connected to the internet though a normal residential connection which is assigned
a dynamic IP address. However, the server that I run this website on is configured with a static IP
since it's a hosted <a href="https://en.wikipedia.org/wiki/Virtual_private_server">VPS</a>. By proxying all traffic to the Namecheap API through my VPS, I could
add my VPS's static IP to the whitelist and not have to worry about my home IP changing all the
time.</p>
<p>SSH is perfect tool for this. The <a href="https://www.openssh.com/">OpenSSH client</a> supports port forwarding using the <code>-D</code> flag.
By then setting the <code>HTTP[S]_PROXY</code> environment variables to point to the forwarded port, programs
that support those environment variables will transparently forward all their requests through the
proxy.</p>
<p>After a bunch of research and testing, I came up with the following script to easily set up the
temporary proxy:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Source this file to automatically setup and teardown an HTTP* proxy through cmetcalfe.ca</span>
<span class="c1"># Use the PROXY_PORT and PROXY_DEST environment variables to customize the proxy</span>

<span class="nv">PROXY_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROXY_PORT</span><span class="k">:-</span><span class="nv">11111</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">PROXY_DEST</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROXY_DEST</span><span class="k">:-</span><span class="p">&lt;username&gt;@cmetcalfe.ca</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">PID</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$$</span><span class="s2">&quot;</span>

<span class="c1"># Teardown the SSH connection when the script exits</span>
<span class="nb">trap</span> <span class="s1">&#39;ssh -q -S &quot;.ctrl-socket-$PID&quot; -O exit &quot;$PROXY_DEST&quot;&#39;</span> EXIT

<span class="c1"># Set up an SSH tunnel and wait for the port to be forwarded before continuing</span>
<span class="k">if</span> ! ssh -o <span class="nv">ExitOnForwardFailure</span><span class="o">=</span>yes -M -S <span class="s2">&quot;.ctrl-socket-</span><span class="nv">$PID</span><span class="s2">&quot;</span> -f -N -D <span class="s2">&quot;</span><span class="nv">$PROXY_PORT</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$PROXY_DEST</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Failed to open SSH tunnel, exiting&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Set environment variables to redirect HTTP* traffic through the proxy</span>
<span class="nb">export</span> <span class="nv">HTTP_PROXY</span><span class="o">=</span><span class="s2">&quot;socks5://127.0.0.1:</span><span class="nv">$PROXY_PORT</span><span class="s2">&quot;</span>
<span class="nb">export</span> <span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HTTP_PROXY</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>

<p>This script is saved as <code>~/.config/tempproxy.rc</code> and can be sourced to automatically set up a proxy
session and have it be torn down when the script exits.</p>
<p>You'll want to use key-based authentication with an unencrypted private key so that you don't need
to type anything to initiate the SSH session. For this reason you'll probably want to create a
limited user on the target system that can only really do port forwarding. There's a good post on
this <a href="https://askubuntu.com/questions/48129/how-to-create-a-restricted-ssh-user-for-port-forwarding/50000#50000">here</a>.</p>
<h2>Talking to the API through the proxy</h2>
<p>To allow programs that use the <code>tempproxy.rc</code> script to talk to the Namecheap API, the IP address of
the VPS was added to the whitelist. Now that the proxying issue was taken care of, I just needed
to wire up the actual certificate renewal process to use it.</p>
<p>The tool I'm using to talk to the Namecheap DNS API is <a href="https://github.com/AnalogJ/lexicon">lexicon</a>. It can handle manipulating the
DNS records of a ton of providers and integrates really nicely with my <a href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment">ACME</a> client of choice,
<a href="https://github.com/lukas2511/dehydrated">dehydrated</a>. Also, because it's using the <a href="https://github.com/Bemmu/PyNamecheap">PyNamecheap</a> Python library, which in turn uses
<a href="http://python-requests.org">requests</a> under the hood, it will <a href="http://docs.python-requests.org/en/master/user/advanced/#proxies">automatically use the <code>HTTP*_PROXY</code> environment
variables</a> when making requests.</p>
<p>The only tricky bit is that the base install of <code>lexicon</code> won't automatically pull in the packages
required for accessing the Namecheap API. Likewise, <code>requests</code> won't install packages to support
SOCKS proxies. To install all the required packages you'll need to run a command like:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>pip install <span class="s1">&#39;requests[socks]&#39;</span> <span class="s1">&#39;dns-lexicon[namecheap]&#39;</span>
</code></pre></div></td></tr></table></div>

<p>Since lexicon can use environment variables as configuration, I created another small source-able
file at <code>~/.config/lexicon.rc</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Sets environment variables for accessing the Namecheap API</span>

<span class="c1"># Turn on API access and get an API token here:</span>
<span class="c1"># https://ap.www.namecheap.com/settings/tools/apiaccess/</span>
<span class="nb">export</span> <span class="nv">PROVIDER</span><span class="o">=</span>namecheap
<span class="nb">export</span> <span class="nv">LEXICON_NAMECHEAP_USERNAME</span><span class="o">=</span>&lt;username&gt;
<span class="nb">export</span> <span class="nv">LEXICON_NAMECHEAP_TOKEN</span><span class="o">=</span>&lt;api token&gt;
</code></pre></div></td></tr></table></div>

<p>With that in place, the existing automation script that I had previously set up when I switched to
using the <code>dns-01</code> challenge just needed some minor tweaks to source the two new files. I've
provided the script below, along with some other useful ones that use the DNS API.</p>
<h2>Scripts</h2>
<h3><code>do-letsencrypt.sh</code></h3>
<p>This is the main script that handles all the domain renewals. It's called via <code>cron</code> on the first
of every month.</p>
<p>Fun fact: The previous <code>http-01</code> version of this script was a mess - it involved juggling <code>nginx</code>
configurations with symlinks, manually opening up the <code>.well-known/acme-challenge</code> endpoint, and
some other terrible hacks. This version is <em>much</em> nicer.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Generate/renew Let&#39;s Encrypt certificates using dehydrated and lexicon</span>

<span class="nb">set</span> -e

<span class="c1"># Set configuration variables and setup the proxy</span>
<span class="nb">source</span> ~/.config/lexicon.rc
<span class="nb">source</span> ~/.config/tempproxy.rc

<span class="nb">cd</span> /etc/nginx/ssl

<span class="c1"># Update the certs.</span>
<span class="c1"># Hook script copied verbatim from</span>
<span class="c1"># https://github.com/AnalogJ/lexicon/blob/master/examples/dehydrated.default.sh</span>
<span class="k">if</span> ! dehydrated --accept-terms --cron --challenge dns-01 --hook dehydrated.default.sh<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Failed to renew certificates&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Reload the nginx config if it&#39;s currently running</span>
<span class="k">if</span> ! systemctl is-active nginx.service &gt; /dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;nginx isn&#39;t running, not reloading it&quot;</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="k">if</span> ! systemctl reload nginx.service<span class="p">;</span> <span class="k">then</span>
    systemctl status nginx.service
    <span class="nb">echo</span> <span class="s2">&quot;Failed to reload nginx config, check the error log&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
</code></pre></div></td></tr></table></div>

<h3><code>dns.sh</code></h3>
<p>This one is really simple - it just augments the normal lexicon CLI interface with the proxy and
configuration variables.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># A simple wrapper around lexicon.</span>
<span class="c1"># Sets up the proxy and configuration, then passes all the arguments to the configured provider</span>

<span class="nb">source</span> ~/.config/lexicon.rc
<span class="nb">source</span> ~/.config/tempproxy.rc
lexicon <span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>$ ./dns.sh list cmetcalfe.ca A
ID       TYPE NAME             CONTENT         TTL
-------- ---- ---------------- --------------- ----
xxxxxxxx A    @.cmetcalfe.ca   xxx.xxx.xxx.xxx <span class="m">1800</span>
xxxxxxxx A    www.cmetcalfe.ca xxx.xxx.xxx.xxx <span class="m">1800</span>
</code></pre></div></td></tr></table></div>

<h3><code>dns-update.sh</code></h3>
<p>An updated version of my <a href="../../blog/dynamic-dns-client-for-namecheap.html">previous script</a> that uses the API instead of the
<a href="https://www.namecheap.com/support/knowledgebase/article.aspx/29/11/how-do-i-use-a-browser-to-dynamically-update-the-hosts-ip">DynamicDNS service Namecheap provides</a>. Called via <code>cron</code> every 30 minutes.</p>
<div class="admonition update">
<p class="admonition-title">Update</p>
<p>A previous version of this script didn't try to delete the DNS entry before setting the new one,
resulting in multiple IPs being set as the same <code>A</code> record.</p>
<p>This is because the <a href="https://github.com/AnalogJ/lexicon/blob/1feca5ead36cbf85ad92676dc853045e2c646097/lexicon/providers/namecheap.py#L233">update function of the Namecheap plugin for lexicon</a> is implemented as a
2-step delete and add. When it tries to delete the old record, it looks for one with the same
content as the old one. This means that if you update a record with a new IP, it doesn't find
the old record to delete first, leaving you with all of your old IPs set as individual A
records.</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Check the server&#39;s current IP against the IP listed in its DNS entry.</span>
<span class="c1"># Set the current IP if they differ.</span>

<span class="nb">set</span> -e

resolve<span class="o">()</span> <span class="o">{</span>
    <span class="nv">line</span><span class="o">=</span><span class="k">$(</span>drill <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> @resolver1.opendns.com <span class="m">2</span>&gt; /dev/null <span class="p">|</span> sed <span class="s1">&#39;/;;.*$/d;/^\s*$/d&#39;</span> <span class="p">|</span> grep <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="p">|</span> head -1 <span class="p">|</span> cut -f5
<span class="o">}</span>

<span class="nv">dns</span><span class="o">=</span><span class="k">$(</span>resolve &lt;subdomain&gt;.cmetcalfe.ca<span class="k">)</span>
<span class="nv">curr</span><span class="o">=</span><span class="k">$(</span>resolve myip.opendns.com<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$dns</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$curr</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">source</span> ~/.config/lexicon.rc
    <span class="nb">source</span> ~/.config/tempproxy.rc
    <span class="k">if</span> ! lexicon <span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span> delete cmetcalfe.ca A --name <span class="s2">&quot;&lt;subdomain&gt;.cmetcalfe.ca&quot;</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Failed to delete old DNS record, not setting the new one.&quot;</span>
        <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> lexicon <span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span> update cmetcalfe.ca A --name <span class="s2">&quot;&lt;subdomain&gt;.cmetcalfe.ca&quot;</span> --content <span class="s2">&quot;</span><span class="nv">$curr</span><span class="s2">&quot;</span> --ttl<span class="o">=</span><span class="m">900</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Server DNS record updated (</span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Server DNS record update FAILED (tried </span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>
</code></pre></div></td></tr></table></div>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
  </span>
  <span id="right">
      <a href="../../blog/tags/shell-script2.html">Next <i class="fa fa-arrow-circle-right"></i></a>
  </span>
  <div>
      <a href="../../blog/tags/shell-script.html">[1]</a>
      <a href="../../blog/tags/shell-script2.html"> 2 </a>
      <a href="../../blog/tags/shell-script3.html"> 3 </a>
      <a href="../../blog/tags/shell-script4.html"> 4 </a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>