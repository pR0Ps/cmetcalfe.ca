<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts tagged with 'shell script' on this site">

  <link rel="stylesheet" type="text/css" href="../../theme/css/styles.ec0bdb0f.min.css">

  <script src="../../theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />


  <title>Tag: shell script | Carey Metcalfe</title>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-DXC76BHD2F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DXC76BHD2F');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="../..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href="../.." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="../..">Home</a>

      &#124; <a href="../../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>Tag: shell script
</p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="../../blog/bank-of-canada-conversion-rates-terminal.html">Bank of Canada currency conversion rates in the terminal</a></h1>
  </div>
  <div class="article_text">
    <h1>Preface</h1>
<p>In this entry I'll use two command line tools (<a href="https://curl.haxx.se/"><code>curl</code></a> and <a href="https://stedolan.github.io/jq/"><code>jq</code></a>) to request currency
conversion rates from the <a href="https://www.bankofcanada.ca">Bank of Canada</a>. Now obviously getting the same data through the <a href="https://www.bankofcanada.ca/rates/exchange/daily-exchange-rates-lookup/">normal
web interface</a> is possible as well. However, doing it this way returns the data in a
machine-readable form, allowing it to be customized or used as input into other programs.</p>
<p>The basic flow will be request the data using <code>curl</code>, then pipe it to <code>jq</code> for processing.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This article will request the USD/CAD exchange rate from 2017-01-01 to 2017-01-10. It should be
fairly obvious how to switch this for any other currencies or date ranges. See the
<a href="#appendix">Appendix</a> for more information and caveats with the dates and the conversion codes.</p>
</div>
<p>We'll go from seeing the raw data the server returns to something that we can more easily use. <strong>To
skip to the final result, click <a href="#tldr">here</a></strong>.</p>
<div class="admonition update">
<p class="admonition-title">Update</p>
<p>The URLs for the data were originally reverse-engineered from the website. They have since been
turned into a supported API. See <a href="https://www.bankofcanada.ca/valet/docs">the API documentation</a> for more details.</p>
</div>
<h1>Lets go!</h1>
<p>Hitting the server without any processing will give the following result:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="nt">&quot;terms&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="nt">&quot;url&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://www.bankofcanada.ca/terms/&quot;</span>
<span class="p">},</span>
<span class="nt">&quot;seriesDetail&quot;</span><span class="p">:{</span>
<span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;USD/CAD&quot;</span><span class="p">,</span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;US dollar to Canadian dollar daily exchange rate&quot;</span><span class="p">}</span>
<span class="p">},</span>
<span class="nt">&quot;observations&quot;</span><span class="p">:[</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-02&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;e&quot;</span><span class="p">:</span><span class="mi">-64</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-03&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3435</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-04&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3315</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-05&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3244</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-06&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3214</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-09&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3240</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-10&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3213</span><span class="p">}}</span>
<span class="p">]</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>To get the information we want, we need to iterate over the elements in the <code>observations</code> list and
map the date (<code>d</code>) to the conversion rate (<code>FXUSDCAD.v</code>). Since this will create a list of
single-element dictionaries, we'll also need to "add" (merge) them together.</p>
<p>To do this with <code>jq</code>, it looks like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span><span class="w"> </span><span class="p">|</span><span class="se">\</span>
jq<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add</span>
<span class="s1">&#39;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;2017-01-02&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-03&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3435</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-04&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3315</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-05&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3244</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-06&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3214</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-09&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.324</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-10&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3213</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>That first <code>null</code> entry where there was no data is going to cause problems later, so let's just
delete it using the <code>del</code> function:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span><span class="w"> </span><span class="p">|</span><span class="se">\</span>
jq<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add | del(.[] | nulls)</span>
<span class="s1">&#39;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;2017-01-03&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3435</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-04&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3315</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-05&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3244</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-06&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3214</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-09&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.324</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;2017-01-10&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3213</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>Now this may be good enough for most purposes, but it would be useful to compute some other
statistics from this data. For example, we want to know the average exchange rate for the date
range. Now that we have the data in an easy to use format, computing an average with <code>jq</code> is just a
matter of passing the values to an <code>add / length</code> filter. For example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span><span class="w"> </span><span class="p">|</span><span class="se">\</span>
jq<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add | del(.[] | nulls) | add / length</span>
<span class="s1">&#39;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="mf">1.327683333333333</span>
</code></pre></div></td></tr></table></div>

<p><a name="tldr"></a>We can now construct an object that has both the average, as well as all the
data. Putting it all together we get:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span><span class="w"> </span><span class="p">|</span><span class="se">\</span>
jq<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add | del(.[] | nulls) |</span>
<span class="s1">    {</span>
<span class="s1">        &quot;average&quot;: (add / length),</span>
<span class="s1">        &quot;values&quot;: .</span>
<span class="s1">    }</span>
<span class="s1">&#39;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;average&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.327683333333333</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;values&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;2017-01-03&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3435</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;2017-01-04&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3315</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;2017-01-05&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3244</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;2017-01-06&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3214</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;2017-01-09&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.324</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;2017-01-10&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1.3213</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>And that's it! Hopefully you found this useful, if not for it's stated purpose of retrieving
exchange rates, then at least for getting more familiar with <code>jq</code>. It's pretty much the best tool
out there when it comes to manipulating JSON on the command line.</p>
<h1>Appendix<a name="appendix"></a></h1>
<h3>Date ranges</h3>
<ul>
<li>The server will only ever return data from <code>2017-01-03</code> and onwards. If the start range is before
  that, it doesn't return an error, it just doesn't return any data for those dates.</li>
<li>If the end date isn't specified, the server assumes the current date.</li>
<li>There doesn't seem to be any limit on the amount of data retrieved</li>
</ul>
<h3>Currency codes</h3>
<p>A list of codes can be easily scraped from the lookup page. The command and its result are below for
reference.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;https://www.bankofcanada.ca/rates/exchange/daily-exchange-rates-lookup/&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-Eo<span class="w"> </span><span class="s1">&#39;&quot;FX......&quot;.*&lt;&#39;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code>&quot;FXAUDCAD&quot;&gt;Australian dollar&lt;
&quot;FXBRLCAD&quot;&gt;Brazilian real&lt;
&quot;FXCNYCAD&quot;&gt;Chinese renminbi&lt;
&quot;FXEURCAD&quot;&gt;European euro&lt;
&quot;FXHKDCAD&quot;&gt;Hong Kong dollar&lt;
&quot;FXINRCAD&quot;&gt;Indian rupee&lt;
&quot;FXIDRCAD&quot;&gt;Indonesian rupiah&lt;
&quot;FXJPYCAD&quot;&gt;Japanese yen&lt;
&quot;FXMYRCAD&quot;&gt;Malaysian ringgit&lt;
&quot;FXMXNCAD&quot;&gt;Mexican peso&lt;
&quot;FXNZDCAD&quot;&gt;New Zealand dollar&lt;
&quot;FXNOKCAD&quot;&gt;Norwegian krone&lt;
&quot;FXPENCAD&quot;&gt;Peruvian new sol&lt;
&quot;FXRUBCAD&quot;&gt;Russian ruble&lt;
&quot;FXSARCAD&quot;&gt;Saudi riyal&lt;
&quot;FXSGDCAD&quot;&gt;Singapore dollar&lt;
&quot;FXZARCAD&quot;&gt;South African rand&lt;
&quot;FXKRWCAD&quot;&gt;South Korean won&lt;
&quot;FXSEKCAD&quot;&gt;Swedish krona&lt;
&quot;FXCHFCAD&quot;&gt;Swiss franc&lt;
&quot;FXTWDCAD&quot;&gt;Taiwanese dollar&lt;
&quot;FXTHBCAD&quot;&gt;Thai baht&lt;
&quot;FXTRYCAD&quot;&gt;Turkish lira&lt;
&quot;FXGBPCAD&quot;&gt;UK pound sterling&lt;
&quot;FXUSDCAD&quot;&gt;US dollar&lt;
&quot;FXVNDCAD&quot;&gt;Vietnamese dong&lt;
</code></pre></div></td></tr></table></div>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../../blog/dynamic-dns-client-for-namecheap.html">Dynamic DNS client for Namecheap using bash & cron</a></h1>
  </div>
  <div class="article_text">
    <p>In addition to running this website, I also run a home server. For convenience,
I point a subdomain of <code>cmetcalfe.ca</code> at it so even though it's connected using
a dynamic IP (and actually seems to change fairly frequently), I can get access
to it from anywhere.</p>
<p>As a bit of background, the domain for this website is registered and managed
through <a href="http://namecheap.com">Namecheap</a>. While they do provide a <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/28">recommended DDNS client</a> for
keeping a domain's DNS updated, it only runs on Windows.</p>
<p>Instead, after <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/595">enabling DDNS for the domain</a> and reading <a href="https://www.namecheap.com/support/knowledgebase/article.aspx/29">Namecheap's article
on using the browser to update DDNS</a> I came up with the following <code>dns-update</code>
script.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>

<span class="c1"># Abort if anything goes wrong (negates the need for error-checking)</span>
<span class="nb">set</span><span class="w"> </span>-e

<span class="c1"># Uses drill instead of dig</span>
resolve<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="c1">#dig &quot;$1&quot; @resolver1.opendns.com +short 2&gt; /dev/null</span>
<span class="w">    </span><span class="nv">line</span><span class="o">=</span><span class="k">$(</span>drill<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>@resolver1.opendns.com<span class="w"> </span><span class="m">2</span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;/;;.*$/d;/^\s*$/d&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f5
<span class="o">}</span>

<span class="nv">dns</span><span class="o">=</span><span class="k">$(</span>resolve<span class="w"> </span>&lt;subdomain&gt;.cmetcalfe.ca<span class="k">)</span>
<span class="nv">curr</span><span class="o">=</span><span class="k">$(</span>resolve<span class="w"> </span>myip.opendns.com<span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$dns</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$curr</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>curl<span class="w"> </span>-s<span class="w"> </span><span class="s2">&quot;https://dynamicdns.park-your-domain.com/update?host=&lt;subdomain&gt;&amp;domain=cmetcalfe.ca&amp;password=&lt;my passkey&gt;&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;&lt;ErrCount&gt;0&lt;/ErrCount&gt;&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Server DNS record updated (</span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Server DNS record update FAILED (tried </span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">fi</span>
</code></pre></div></td></tr></table></div>

<p>It basically checks if the IP returned by a DNS query for the subdomain matches
the current IP of the server (as reported by an <a href="https://en.wikipedia.org/wiki/OpenDNS">OpenDNS</a> resolver) and if it
doesn't, sends a request to update the DNS. The <code>echo</code> commands are there just
to output some record of the IP changing. Maybe I'll do some analysis of it at
some point.</p>
<p>To run the script every 30 minutes and redirect any output from it to the
syslog, the following <a href="http://en.wikipedia.org/wiki/Cron">crontab</a> entry can be used:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>*/30<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>/path/to/dns-update<span class="w"> </span><span class="p">|</span><span class="w"> </span>/usr/bin/logger<span class="w"> </span>-t<span class="w"> </span>dns-update
</code></pre></div></td></tr></table></div>

<p>With the script automatically running every 30 minutes I can now be confident
that my subdomain will always be pointing at my home server whenever I need
access to it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A previous version of this article used <code>curl -sf http://curlmyip.com</code> to
find the server's current IP address. However, after curlmyip went down for
a few days, I decided to take the advice in <a href="http://unix.stackexchange.com/a/81699">this StackExchange answer</a>
and use <a href="https://en.wikipedia.org/wiki/OpenDNS">OpenDNS</a> instead.</p>
</div>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../../blog/git-checkout-autocomplete-local-branches-only.html">Git checkout - autocomplete local branches only</a></h1>
  </div>
  <div class="article_text">
    <p>Having Git autocomplete branch names when doing a checkout is super useful.  Having the autocomplete
hang for 30 seconds because it has to look up all 3000 of the remote branches in a massive repo is
not so useful. It's actually pretty frustrating.</p>
<p>My solution: changing the <code>git checkout</code> autocomplete to only look at local branches, while using a
<code>git checkoutr</code> alias to preserve the original behaviour (because sometimes it's actually needed).</p>
<p>How it's done:</p>
<h2>Define an alias for checkout</h2>
<p>We're going to use the same checkout command for the remote checkout, but need to have a different
command so the script can differentiate between them.  Making an alias does exactly this.</p>
<p>Create the alias by running <code>git config --global alias.checkoutr checkout</code></p>
<h2>Change the autocompletion function</h2>
<p>The checkout autocomplete behaviour is defined in a function called <code>_git_checkout</code> in the git
autocompletion file. We're going to override the function with our own version that has different
autocomplete logic in it.</p>
<p>The location of the file varies over different operating systems and configurations, but here are a
few spots to look:</p>
<ul>
<li><code>/etc/bash_completion.d/git</code></li>
<li><code>/usr/share/bash-completion/completions/git</code></li>
</ul>
<p>For a brew-installed git autocomplete on macOS, the file will probably be
<code>$(brew --prefix)/etc/bash_completion.d/git-completion.bash</code></p>
<p>Once you've found the file, copy the entire <code>_git_checkout</code> function into your <code>.bashrc</code> (or
equivalent non-login shell startup script). Now look for the line</p>
<p><code>__git_complete_refs $track_opt</code></p>
<p>We're going to replace that line with:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$command</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;checkoutr&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>__git_complete_refs<span class="w"> </span><span class="nv">$track_opt</span>
<span class="k">else</span>
<span class="w">    </span>__gitcomp_direct<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>__git_heads<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cur</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="k">fi</span>
</code></pre></div></td></tr></table></div>

<p>After saving and re-sourcing your <code>.bashrc</code> file, git will autocomplete local branches and tags when
using <code>git checkout</code>, but will go back to the default behaviour of autocompleting all references
when using <code>git checkoutr</code>.</p>
<p>Credits to a combination of answers on <a href="disable-auto-completion-of-remote-branches-in-git-bash">this</a> StackOverflow post.</p>
<p>EDIT 2017-10-02: Updated to work with <a href="https://github.com/git/git/commit/15b4a163950c2e8660a7797ce3975ccea8705f80#diff-f37c4f4a898819f0ca4b5ff69e81d4d9">git v2.13.0</a> thanks to <a href="https://gist.github.com/mmrko/b3ec6da9bea172cdb6bd83bdf95ee817#gistcomment-2218059">Alexander Ko's comment</a>.<br>
EDIT 2018-03-24: Updated to <a href="https://github.com/git/git/commit/227307a639c96b3579b7fe60840fdae123d1ee88">speed up branch and tag completion</a>.</p>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
      <a href="../../blog/tags/shell-script.html"><i class="fa fa-arrow-circle-left"></i> Prev</a>
  </span>
  <span id="right">
      <a href="../../blog/tags/shell-script3.html">Next <i class="fa fa-arrow-circle-right"></i></a>
  </span>
  <div>
      <a href="../../blog/tags/shell-script.html"> 1 </a>
      <a href="../../blog/tags/shell-script2.html">[2]</a>
      <a href="../../blog/tags/shell-script3.html"> 3 </a>
      <a href="../../blog/tags/shell-script4.html"> 4 </a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>