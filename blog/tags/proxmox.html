<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts tagged with 'proxmox' on this site">

  <link rel="stylesheet" type="text/css" href="../../theme/css/styles.ec0bdb0f.min.css">

  <script src="../../theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />


  <title>Tag: proxmox | Carey Metcalfe</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28306875-1', 'cmetcalfe.ca');
  ga('send', 'pageview');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="../..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href="../.." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="../..">Home</a>

      &#124; <a href="../../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>Tag: proxmox
</p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="../../blog/remove-proxmox-subscription-notice.html">Removing the Proxmox VE subscription notice</a></h1>
  </div>
  <div class="article_text">
    <p><a href="https://www.proxmox.com/proxmox-ve">Proxmox VE</a> is an open-source (<a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL v3</a>) virtualization platform for running containers and
VMs. It's comparable to a proprietary solution like <a href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a>.</p>
<p>It can be downloaded and installed completely free of charge, lacking only access to support and
other things that more enterprise-focused users care about. For a homelab install, the free version
is perfect.</p>
<p>...except for one thing. Each time you log in, you have to click through this dialog:</p>
<p><img alt="&quot;You do not have a valid subscription for this server. Please visit www.proxmox.com to get a list of available options.&quot;" src="../../images/proxmox_subscription_notice.png"></p>
<p>The goal of this post is to walk through developing a solution to automatically remove that
notification in any installed version of Proxmox VE, as well as have that removal survive future
updates.</p>
<p><strong>To skip to the solution, click <a href="#the-solution">here</a>.</strong></p>
<h1>Developing a patch</h1>
<p>Searching the internet reveals that a few other people (<a href="https://johnscs.com/remove-proxmox51-subscription-notice/">1</a>, <a href="https://dannyda.com/2020/05/17/how-to-remove-you-do-not-have-a-valid-subscription-for-this-server-from-proxmox-virtual-environment-6-1-2-proxmox-ve-6-1-2-pve-6-1-2/">2</a>, <a href="https://www.jamescoyle.net/how-to/614-remove-the-proxmox-no-subscription-message">3</a>) have already attacked
this problem. All articles point to some code in
<code>/usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</code> being responsible for the notification
so this is where we'll start.</p>
<p>Scanning though that file reveals a function called <a href="https://git.proxmox.com/?p=proxmox-widget-toolkit.git;a=blob;f=src/Utils.js;h=85387946165e592e89a65e6973dc7f1836edc984;hb=HEAD#l460"><code>checked_command(orig_cmd)</code></a>.
This function just executes <code>orig_cmd</code> after showing the subscription notification if it determines
that you don't have a valid subscription.</p>
<p>Based on this, the goal of this patch will be to make <code>checked_command</code> always execute <code>orig_cmd</code>
without bothering to check if there is a subscription at all. As a bonus, this will also speed up
the login process since it removes a blocking call to the server<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>.</p>
<p>Since we want this patch to work for as many versions as possible, it's a good idea to take a look
into how this function has changed over time. By looking at the <a href="https://git.proxmox.com/?p=proxmox-widget-toolkit.git">proxmox-widget-toolkit</a> history,
we can see that <code>checked_command</code> was originally added in commit <a href="https://git.proxmox.com/?p=proxmox-widget-toolkit.git;a=commitdiff;h=5f93e010854dadb38fa1e7d10c00f42df38cedd4"><code>5f93e010</code></a>. However, it
was actually moved from the <a href="https://git.proxmox.com/?p=pve-manager.git;">pve-manager</a> project where it was written for the <a href="https://git.proxmox.com/?p=pve-manager.git;a=commitdiff;h=1556735e9c4dfdd13d1b0823942adf8feb003891">initial
implementation of the subscription notice</a>. By looking at the entire history of this function we can see that
while the function implementation has changed slightly over time, the name, arguments, and goal of
it has stayed exactly the same.</p>
<p>Given this, as long as we only use the function definition to do the patch, it should work for every
version of Proxmox VE to date (and hopefully into the future). Using <code>sed</code> to prepend <code>orig_cmd();
return;</code> to the function should work nicely:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sed<span class="w"> </span>--in-place<span class="w"> </span><span class="s1">&#39;s/checked_command: function(orig_cmd) {$/&amp; orig_cmd(); return;/&#39;</span><span class="w"> </span>/usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
</code></pre></div></td></tr></table></div>

<p>This results in the following change:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="gd">-checked_command: function(orig_cmd) {</span>
<span class="gi">+checked_command: function(orig_cmd) { orig_cmd(); return;</span>
</code></pre></div></td></tr></table></div>

<p>Notice that the <code>sed</code> script is looking for the function definition followed by a line ending (<code>$</code>).
Because the patch is added to the same line, if the command is run again it won't match and won't
make any changes, making it safe to blindly run multiple times. This becomes important for
automating it later.</p>
<p>Now that we know it works, we should harden it up against whitespace changes by replacing the spaces
in the regex with <code>\s*</code> (0 or more whitespace characters):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sed<span class="w"> </span>--in-place<span class="w"> </span><span class="s1">&#39;s/checked_command:\s*function(orig_cmd)\s*{\s*$/&amp; orig_cmd(); return;/&#39;</span><span class="w"> </span>/usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
</code></pre></div></td></tr></table></div>

<p>The only thing left to solve is which file <code>checked_command</code> is defined in. Since it used to be a
part of the <code>pve-manager</code> project, it's safe to say that it wasn't always stored in
<code>/usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js</code>. It could also move around in the
future.</p>
<p>To deal with this, we use <code>grep</code> to find the file that it's defined in, then run the previous
command over that file:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>grep<span class="w"> </span>--files-with-matches<span class="w"> </span>--include<span class="w"> </span><span class="s1">&#39;*.js&#39;</span><span class="w"> </span>--recursive<span class="w"> </span>--null<span class="w"> </span><span class="s1">&#39;checked_command:\s*function(orig_cmd)&#39;</span><span class="w"> </span>/usr/share/<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>--null<span class="w"> </span>--no-run-if-empty<span class="w"> </span>sed<span class="w"> </span>--in-place<span class="w"> </span><span class="s1">&#39;s/checked_command:\s*function(orig_cmd)\s*{\s*$/&amp; orig_cmd(); return;/&#39;</span>
</code></pre></div></td></tr></table></div>

<p>Simply run this command on your Proxmox VE server<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>, refresh the web UI, and the notice should be
gone!</p>
<h1>Automating it</h1>
<p>At this point we have a working command that will remove the subscription notice from any version of
Proxmox VE to date. However, after updating the system, there's a chance that a newer version of the
file will have overwritten our patched version.</p>
<p>While we could just save the command in a script and manually run it after every update, that's
annoying and will definitely be forgotten. Instead, we want to automatically run the command every
time the web server starts. This will ensure that it will always be serving a patched version of the
file.</p>
<p>Proxmox VE uses <a href="https://systemd.io/"><code>systemd</code></a> to manage the startup of its services. This means that once we
find the service that manages the web server, we should be able to make <code>systemd</code> launch a service
that applies our patch just before the web server.</p>
<p>The first step is to find the service that manages the web server. Since we know it's running on
port 8006, we can use <code>netstat</code> to enumerate all listening TCP ports and <code>grep</code> to filter it down to
just the port we're interested in:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>netstat<span class="w"> </span>--listening<span class="w"> </span>--tcp<span class="w"> </span>--numeric-ports<span class="w"> </span>--program<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="m">8006</span>
tcp<span class="w">  </span><span class="m">0</span><span class="w">  </span><span class="m">0</span><span class="w">  </span><span class="m">0</span>.0.0.0:8006<span class="w">  </span><span class="m">0</span>.0.0.0:*<span class="w">  </span>LISTEN<span class="w">  </span><span class="m">15771</span>/pveproxy
</code></pre></div></td></tr></table></div>

<p>Once we know the PID of the program, running <code>systemctl status &lt;PID&gt;</code> will show the status
(including the service name) of the service that's managing it<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>. In this case it shows that the
service is <code>pveproxy.service</code>.</p>
<p>We can now define a service that runs our code, is wanted by <code>pveproxy.service</code>, and
must be run before it. Then, whenever <code>systemd</code> starts (or restarts) <code>pveproxy.service</code>, it will
make sure to also run our service that applies the patch.</p>
<h1>The solution</h1>
<p><a name="the-solution"></a>
Putting it all together:</p>
<p>1. Create <code>/etc/systemd/system/no-subscription-notice.service</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Remove Proxmox VE subscription notice</span>
<span class="na">Before</span><span class="o">=</span><span class="s">pveproxy.service</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/sh -c &quot;grep --files-with-matches --include &#39;*.js&#39; --recursive --null &#39;checked_command:\s*function(orig_cmd)&#39; /usr/share/ | xargs --null --no-run-if-empty sed --in-place &#39;s/checked_command:\s*function(orig_cmd)\s*{\s*$/&amp; orig_cmd()</span><span class="c1">; return;/&#39;&quot;</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">pveproxy.service</span>
</code></pre></div></td></tr></table></div>

<p>2. <code>systemctl enable --now no-subscription-notice.service</code></p>
<p>And that's it! The subscription notice should now be gone for good. I'll update this post if it
breaks, but that hopefully won't be for a while.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>Interestingly, the existing solutions I found all patch the code that checks the returned
    subscription status instead of just not asking about the status at all. Compared to the
    solution here, this is both more fragile, as well as slower.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Commands can be run from the web UI (Datacenter -&gt; node -&gt; Shell), via SSH, or just by
    using a keyboard and monitor hooked up to the server.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>Another way to go from PID or command to service name is to use <code>ps</code> like so:
    <code>ps --format=unit= &lt;PID&gt;</code> or <code>ps --format=unit= -C &lt;cmd&gt;</code>. Note that this requires your
    version of <code>ps</code> to be compiled with <code>systemd</code> support (which it is in most <code>systemd</code>-based
    distros).&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
  </span>
  <span id="right">
  </span>
  <div>
      <a href="../../blog/tags/proxmox.html">[1]</a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>