<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts by Carey Metcalfe">

  <link rel="stylesheet" type="text/css" href="../theme/css/styles.518a5e28.min.css">

  <script src="../theme/js/scripts.ab06d70e.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />

  <meta name="keywords" content="blog, carey, cmetcalfe, metcalfe, pr0ps, pr0pscm, android, application, automation, backup, chromecast, code, data recovery, electronics, email, games, git, hardware, iphone, let's encrypt, linux, macOS, mercurial, networking, png, python, queen's university, router, security, shell script, sites, steam, vim, website, windows, wine">

  <title>Blog | Carey Metcalfe</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28306875-1', 'cmetcalfe.ca');
  ga('send', 'pageview');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href=".." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="..">Home</a>

      &#124; <a href="../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>
<a href="../blog/index.html">Posts</a>
&#124; <a href="../blog/tags/">Tags</a>
&#124; <a href="../blog/archives.html">Archive</a>
</p>    </header>

<article>
  <div class="article_title">
    <h1><a href="../blog/adding-xbox360-controller-support-to-a-nexus5.html">Adding Xbox 360 controller support to a Nexus 5</a></h1>
  </div>
  <div class="article_text">
    <div class="admonition update">
<p class="admonition-title">Update</p>
<p>CyanogenMod has effectively been replaced by <a href="https://lineageos.org/">LineageOS</a>. The links in this article originally
all pointed to CyanogenMod but since it no longer exists, I've updated them to use the LineageOS
equivilents where possible. The instructions will also need to be slightly modified for use with
LineageOS builds.</p>
</div>
<h2>Introduction</h2>
<p>I finally just bought a new phone (a <a href="http://en.wikipedia.org/wiki/Nexus_5">Nexus 5</a>), and after flashing <a href="https://en.wikipedia.org/wiki/CyanogenMod">CyanogenMod</a> onto it, I've
been messing around with its <a href="http://en.wikipedia.org/wiki/USB_On-The-Go">OTG</a> support. My old phone (a <a href="http://en.wikipedia.org/wiki/Nexus_4">Nexus 4</a>) <a href="http://blog.gsmarena.com/nexus-4-does-not-support-usb-otg-despite-google-saying-otherwise/">didn't have the
capability</a> so being able to plug in keyboards, mice, external hard drives, and various other
peripherals was (embarrassingly enough) a thrill.</p>
<p>Keyboards worked, mice worked, but when an Xbox 360 controller was plugged in, nothing happened.
Turns out that while the kernel didn't have support for it enabled out of the box, getting it
enabled and pushing the change upstream into the CyanogenMod project was easier than I thought.</p>
<p>Beware that this post is going to be more of a record of what I did so that I can do it again and
less of a coherent tutorial.</p>
<h2>Building CyanogenMod</h2>
<p>First step was to download and compile CyanogenMod for my phone. I'm not going to go into this in
any detail on this because there's already a <a href="https://web.archive.org/web/20161224200646/https://wiki.cyanogenmod.org/w/Development">good overview</a> on the CyanogenMod wiki that covers
the entire process, as well as a <a href="https://wiki.lineageos.org/devices/hammerhead/build">customized guide for the Nexus 5</a>. If those articles are
followed correctly, you should be able to build a fresh CyanogenMod image with:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>brunch hammerhead
</pre></div>
</td></tr></table>

<h2>Enabling the kernel module</h2>
<p>Once the image was flashed to the phone and verified to be working, the next step was to enable the
<a href="https://www.kernel.org/doc/html/v4.16/input/devices/xpad.html">xpad kernel module</a>.</p>
<p>Copy current kernel config to the kernel directory for editing:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nb">cd</span> &lt;build dir&gt;/kernel/lge/hammerhead/
cp arch/arm/configs/cyanogenmod_hammerhead_defconfig .config
</pre></div>
</td></tr></table>

<p>Edit the config:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>make menuconfig <span class="nv">ARCH</span><span class="o">=</span>arm
</pre></div>
</td></tr></table>

<p>At this point, a menu will come up. Search for <code>xpad</code> (type <code>/xpad</code>), and take note of the paths.
<code>ESC</code> out of the search, navigate the tree and enable the modules found with the search. Save and
exit.</p>
<p>Copy the config back and clean up any stray <code>*.o</code> files:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>cp .config arch/arm/configs/cyanogenmod_hammerhead_defconfig
make mrproper
</pre></div>
</td></tr></table>

<p>After enabling the module, rebuild CyanogenMod using the normal <code>brunch hammerhead</code> and flash it to
the phone.</p>
<h2>Submitting the change upstream</h2>
<p>Since Xbox controller support had already been requested in <del><a href="https://jira.cyanogenmod.org/browse/CYAN-4469">a JIRA ticket</a></del>(dead link), I went
through the process to submit <a href="https://review.lineageos.org/#/c/LineageOS/android_kernel_lge_hammerhead/+/87409/">the change</a> on the CyanogenMod Gerrit instance for inclusion in the
next release. There's a guide for this <a href="https://wiki.lineageos.org/submitting-patch-howto.html">here</a>. As well as the guide, I found the people in
<a href="https://webchat.freenode.net/?channels=#cyanogenmod-dev">#cyanogenmod-dev on Freenode</a> to be very helpful.</p>
<p>A short while after submitting <a href="https://review.lineageos.org/#/c/LineageOS/android_kernel_lge_hammerhead/+/87409/">the change</a> to Gerrit, it was merged into the <code>cm-11.0</code> branch as
commit <a href="https://github.com/LineageOS/android_kernel_lge_hammerhead/commit/7ef4f6a87cc114b5010b623d72840b1d38ea01ed"><code>i7ef4f6a</code></a> and pushed out in the next nightly build (<a href="../images/cyanogenmod-changelog-xbox-support.png">changelog screenshot</a>).</p>
<h2>Wrap-up</h2>
<p>It feels great to be able to contribute to an amazing open source project that had <a href="https://twitter.com/CyanogenMod/status/157378138802888704">at least a
million people</a> using it at one point or another. I recognize that the change by itself was just
changing a config file to enable functionality that already existed, but it's helped me get through
some of the non-coding hurdles of contributing to an Android fork like CyanogenMod (adb, fastboot,
unlocking and rooting phones, compiling AOSP, flashing images, the contribution process, etc). This
time the actual contribution itself was minor, but it's gotten me more familier with the process,
hopefully making it easier to contribute something more substantial in the future.</p>
<p>In the end, I learned a lot about Android development and how all the different pieces that I had
read about at one point or another actually fit together. During the whole process I also lost a lot
of the fear I had about messing with phones and other more expensive locked down devices. Going
forward, I'm going to attempt to compile and flash open source operating systems like CyanogenMod
onto more devices that I own. I like being able to tweak things and feel like I really own them,
hardware and software.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/fixing-save-corruption-ridiculous-fishing.html">Fixing save file corruption in Ridiculous Fishing</a></h1>
  </div>
  <div class="article_text">
    <p><a href="https://play.google.com/store/apps/details?id=com.vlambeer.RidiculousFishing">Ridiculous Fishing</a> is a game by <a href="http://www.vlambeer.com/">Vlambeer</a> about fishing. That's if you
can call chainsawing fish and blowing them out of the sky with a bazooka "fishing".</p>
<p>I've been playing this game on and off for a while now, but just recently I had
a problem where my save file somehow got corrupted, making the app refuse to open.</p>
<p>The problem first manifested as the game freezing for up to 5 seconds when
navigating around the UI or buying items in the in-game store. Since I was
running the game on a <a href="http://en.wikipedia.org/wiki/Nexus_5">Nexus 5</a> (not the latest and greatest, but pretty
close), it seemed weird. The delay got longer and longer until the game
eventually crashed and refused to reopen.</p>
<p>Since I was pretty far into the game (I only needed to catch one more species
of fish!), I opted to try to fix it instead of just wiping the app's data and
starting again. I initially tried clearing the app's cache and
<a href="../blog/reinstall-android-app-without-losing-data.html">reinstalling the app</a>, but the problem persisted.</p>
<p>The next step was to dump the games's data to my computer so I could do some
analysis on it. Some exploration on the device revealed that the settings and
data were stored in the folder <code>/data/data/com.vlambeer.RidiculousFishing.humble</code>
(I have the <a href="https://www.humblebundle.com/">Humble Bundle</a> version of the app).</p>
<p>To pull that folder to my current directory, I used <a href="http://developer.android.com/tools/help/adb.html">ADB</a>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span>adb root <span class="c1">#Restart adbd on the device with root permissions</span>
adb pull /data/data/com.vlambeer.RidiculousFishing.humble/
</pre></div>
</td></tr></table>

<p>A quick <code>du -h</code> revealed that something was very wrong in the
<code>files/Library/Preferences/com.vlambeer.RidiculousFishing.humble.plist</code> file.
It should've been just a text document, but was well over 200MB.</p>
<p>After trying out of habit to open the file in <a href="http://www.vim.org/">Vim</a> and having it hang (oops),
I paged through the document with <a href="http://en.wikipedia.org/wiki/Less_%28Unix%29">less</a>. About halfway through the file,
there was a line containing <code>&amp;amp;lt;message&amp;amp;gt;@eggbirdTBA Take it to the
Smartypants Bar</code> (no, that's not a formatting error, in the plist there's XML
data stored in a <code>&lt;string&gt;</code> element, requiring the <code>&lt;</code> and <code>&gt;</code> characters to be
escaped) followed by about 200MB of garbage.</p>
<p>Apparently there are <a href="http://stackoverflow.com/questions/908575/how-to-edit-multi-gigabyte-text-files-vim-doesnt-work">ways to load huge files in Vim</a>, as well as other text
editors that handle them nicely, but since I already knew what line was causing
the issue, a simple <a href="http://en.wikipedia.org/wiki/Sed">sed</a> command would do the trick.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>sed <span class="s1">&#39;/Take it to the Smartypants Bar/d&#39;</span> com.vlambeer.RidiculousFishing.humble.plist &gt; temp.plist
</pre></div>
</td></tr></table>

<p>Total size of <code>temp.plist</code>: 107.11KB. Much better.</p>
<p>After going though and deleting some lines around the one that was removed (to
make the XML valid again), I pushed the file back to the device:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>adb push temp.plist /data/data/com.vlambeer.RidiculousFishing.humble/files/Library/Preferences/com.vlambeer.RidiculousFishing.humble.plist
</pre></div>
</td></tr></table>

<p>Success! The game opened properly, all the freezing issues were gone, and my
save data was still there.</p>
<p>Now to find that stupid <a href="http://gaming.stackexchange.com/questions/159564/how-to-catch-the-mimic-fish">Mimic Fish</a>...</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/reinstall-android-app-without-losing-data.html">Reinstalling an Android app without losing data</a></h1>
  </div>
  <div class="article_text">
    <p>When an application isn't opening (and clearing the cache doesn't help) it
sometimes helps to reinstall it. However, uninstalling then reinstalling the
app normally will delete all the data associated with it.</p>
<p>The way around this is to directly call the package manager from the shell and
give it the <code>-k</code> argument, which tells it to keep the data and cache directories.</p>
<p>Simply connect the device to a computer with <a href="http://developer.android.com/tools/help/adb.html">ADB</a> installed and run:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>adb -d shell <span class="s2">&quot;pm uninstall -k com.package.name&quot;</span>
</pre></div>
</td></tr></table>

<p>Then just reinstall the app (either from an apk file or the <a href="https://play.google.com/store">Play Store</a>) and
the app will be back with all of its data intact.</p>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
      <a href="../blog/index4.html"><i class="fa fa-arrow-circle-left"></i> Prev</a>
  </span>
  <span id="right">
      <a href="../blog/index6.html">Next <i class="fa fa-arrow-circle-right"></i></a>
  </span>
  <div>
      <a href="../blog/index.html"> 1 </a>
      <a href="../blog/index2.html"> 2 </a>
      <a href="../blog/index3.html"> 3 </a>
      <a href="../blog/index4.html"> 4 </a>
      <a href="../blog/index5.html">[5]</a>
      <a href="../blog/index6.html"> 6 </a>
      <a href="../blog/index7.html"> 7 </a>
      <a href="../blog/index8.html"> 8 </a>
      <a href="../blog/index9.html"> 9 </a>
      <a href="../blog/index10.html"> 10 </a>
      <a href="../blog/index11.html"> 11 </a>
      <a href="../blog/index12.html"> 12 </a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>