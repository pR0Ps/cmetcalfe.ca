<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts by Carey Metcalfe">

  <link rel="stylesheet" type="text/css" href="../theme/css/styles.ec0bdb0f.min.css">

  <script src="../theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />

  <meta name="keywords" content="blog, carey, cmetcalfe, metcalfe, pr0ps, pr0pscm, android, application, audio, automation, backup, canada, chromecast, code, data recovery, electronics, email, games, git, hardware, homelab, iphone, let's encrypt, linux, macOS, mercurial, networking, nvidia, png, proxmox, python, queen's university, router, security, shell script, sites, steam, vim, website, windows, wine">

  <title>Blog | Carey Metcalfe</title>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-DXC76BHD2F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DXC76BHD2F');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href=".." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="..">Home</a>

      &#124; <a href="../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>
<a href="../blog/index.html">Posts</a>
&#124; <a href="../blog/tags/">Tags</a>
&#124; <a href="../blog/archives.html">Archive</a>
</p>    </header>

<article>
  <div class="article_title">
    <h1><a href="../blog/reducing-chromecast-idle-bandwidth.html">Reducing Chromecast Idle Bandwidth</a></h1>
  </div>
  <div class="article_text">
    <p>Google's <a href="https://store.google.com/product/chromecast">Chromecast</a> is a pretty useful device. It plugs into the HDMI port of a TV and allows
users to "cast" content to it via a smartphone, <a href="https://www.google.com/chrome/">Chrome browser</a>, etc. This content is mostly
assumed to be streaming services like <a href="https://www.youtube.com/">Youtube</a>, <a href="https://www.spotify.com/">Spotify</a>, or <a href="https://www.netflix.com/">Netflix</a>, but for someone who
doesn't really buy into the whole cloud revolution like myself, it's still perfectly capable of
playing local content as well.</p>
<p>The one downside of the Chromecast is that when it's not being used, instead of going into a
low-power state and/or turning off the TV, it instead enters <a href="https://support.google.com/chromecast/answer/6080931">Ambient Mode</a>. This shows some
useful information overlaid on a changing backdrop of featured photos downloaded from <a href="https://photos.google.com/">Google
Photos</a>. The issue with this is that the images are high-resolution, not cached, and are
continually being downloaded 24/7 even when the TV is turned off. Although I haven't personally
measured it, the general consensus seems to be that it uses around 15GB of data per month from just
being plugged in.</p>
<p>What I'll be going over here is reducing the data the Chromecast uses by configuring it to only
download some tiny black 1x1 px images to use as a backdrop.</p>
<h2>The short version</h2>
<ul>
<li>Make a tiny black PNG (<a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==">pixel.png</a>)</li>
<li>Make a slightly different tiny PNG to avoid deduplication (<a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIW2NgAAAAAgABYkBPaAAAAABJRU5ErkJggg==">pixel_alt1.png</a>)</li>
<li>Upload both to an album in Google Photos</li>
<li>Mark both images as favorites</li>
<li>Configure the Chromecast to only pull images from your specific album every 10 minutes</li>
</ul>
<p>If you like details, keep reading...</p>
<h2>Making a small image</h2>
<p>I ended up creating a 1x1 solid black image in GIMP, saving it as a PNG, hacking out as much data as
possible using a hex editor, then using <a href="https://pmt.sourceforge.io/pngcrush/"><code>pngcrush</code></a> to attempt to optimize the data
that was left.</p>
<p>As I was working on the PNG file, I used a small script based on the Python <a href="https://construct.readthedocs.io/en/latest/">construct</a> library to
visualize the chunks and structure of it so I could figure out what to cut.</p>
<p>To install <code>construct</code> and download the example PNG specification:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>.venv
<span class="nb">source</span><span class="w"> </span>.venv/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>construct
wget<span class="w"> </span><span class="s2">&quot;https://raw.githubusercontent.com/construct/construct/abd48c4892ceddc60c11d25f4a955573e2c61111/deprecated_gallery/png.py&quot;</span>
</code></pre></div></td></tr></table></div>

<p>Create <code>pngview.py</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">import</span> <span class="nn">png</span>  <span class="c1"># the png spec downloaded above</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Size:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s2">&quot;bytes&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">png</span><span class="o">.</span><span class="n">png_file</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

<p>Running it on the PNG exported from GIMP using the default settings gives:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>./pngview.py<span class="w"> </span>pixel.png
Size:<span class="w"> </span><span class="m">146</span><span class="w"> </span>bytes
Container:<span class="w"> </span>
<span class="w">    </span><span class="nv">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x89PNG\r\n\x1a\n&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">8</span><span class="o">)</span>
<span class="w">    </span><span class="nv">image_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Container:<span class="w"> </span>
<span class="w">        </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>
<span class="w">        </span><span class="nv">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IHDR&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">        </span><span class="nv">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nv">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nv">bit_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>
<span class="w">        </span><span class="nv">color_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>truecolor<span class="w"> </span><span class="m">2</span>
<span class="w">        </span><span class="nv">compression_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>deflate<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">filter_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>adaptive5<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">interlace_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>none<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2423739358</span>
<span class="w">    </span><span class="nv">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ListContainer:<span class="w"> </span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">9</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;pHYs&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Container:<span class="w"> </span>
<span class="w">                </span><span class="nv">pixels_per_unit_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">11811</span>
<span class="w">                </span><span class="nv">pixels_per_unit_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">11811</span>
<span class="w">                </span><span class="nv">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>meter<span class="w"> </span><span class="m">1</span>
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2024095606</span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;tIME&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Container:<span class="w"> </span>
<span class="w">                </span><span class="nv">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2018</span>
<span class="w">                </span><span class="nv">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span>
<span class="w">                </span><span class="nv">day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">11</span>
<span class="w">                </span><span class="nv">hour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span>
<span class="w">                </span><span class="nv">minute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<span class="w">                </span><span class="nv">second</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">19</span>
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">904567710</span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">25</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;tEXt&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Container:<span class="w"> </span>
<span class="w">                </span><span class="nv">keyword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>u<span class="s1">&#39;Comment&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">7</span><span class="o">)</span>
<span class="w">                </span><span class="nv">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;Created with GIM&#39;</span>...<span class="w"> </span><span class="o">(</span>truncated,<span class="w"> </span>total<span class="w"> </span><span class="m">17</span><span class="o">)</span>
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1468075543</span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IDAT&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x08\xd7c```\x00\x00\x00\x04\x00\x01&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">12</span><span class="o">)</span>
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">657729290</span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IEND&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>None
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2923585666</span>
</code></pre></div></td></tr></table></div>

<p>After removing the unneeded <code>pHYs</code>, <code>tIME</code>, and <code>tEXt</code> chunks using a hex editor, it looks like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>./pngview.py<span class="w"> </span>pixel.png<span class="w"> </span>
Size:<span class="w"> </span><span class="m">69</span><span class="w"> </span>bytes
Container:<span class="w"> </span>
<span class="w">    </span><span class="nv">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x89PNG\r\n\x1a\n&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">8</span><span class="o">)</span>
<span class="w">    </span><span class="nv">image_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Container:<span class="w"> </span>
<span class="w">        </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>
<span class="w">        </span><span class="nv">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IHDR&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">        </span><span class="nv">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nv">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nv">bit_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>
<span class="w">        </span><span class="nv">color_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>truecolor<span class="w"> </span><span class="m">2</span>
<span class="w">        </span><span class="nv">compression_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>deflate<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">filter_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>adaptive5<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">interlace_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>none<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2423739358</span>
<span class="w">    </span><span class="nv">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ListContainer:<span class="w"> </span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IDAT&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x08\xd7c```\x00\x00\x00\x04\x00\x01&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">12</span><span class="o">)</span>
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">657729290</span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IEND&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>None
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2923585666</span>
</code></pre></div></td></tr></table></div>

<p>At this point, all that's left to optimize is the image data itself. This is where <code>pngcrush</code>
shines. After running <code>pngcrush -brute -ow pixel.png</code> we see:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>./pngview.py<span class="w"> </span>pixel.png
Size:<span class="w"> </span><span class="m">67</span><span class="w"> </span>bytes
Container:<span class="w"> </span>
<span class="w">    </span><span class="nv">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x89PNG\r\n\x1a\n&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">8</span><span class="o">)</span>
<span class="w">    </span><span class="nv">image_header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>Container:<span class="w"> </span>
<span class="w">        </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span>
<span class="w">        </span><span class="nv">signature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IHDR&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">        </span><span class="nv">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nv">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<span class="w">        </span><span class="nv">bit_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span>
<span class="w">        </span><span class="nv">color_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>greyscale<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">compression_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>deflate<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">filter_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>adaptive5<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">interlace_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span>enum<span class="o">)</span><span class="w"> </span>none<span class="w"> </span><span class="m">0</span>
<span class="w">        </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">981375829</span>
<span class="w">    </span><span class="nv">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>ListContainer:<span class="w"> </span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IDAT&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x08\x1dc`\x00\x00\x00\x02\x00\x01&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">10</span><span class="o">)</span>
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3486004709</span>
<span class="w">        </span>Container:<span class="w"> </span>
<span class="w">            </span><span class="nv">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
<span class="w">            </span><span class="nb">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;IEND&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">4</span><span class="o">)</span>
<span class="w">            </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>None
<span class="w">            </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2923585666</span>
</code></pre></div></td></tr></table></div>

<p>The 2 byte savings in the data seem to have come from setting the <code>color_type</code> to <code>greyscale</code>
instead of <code>truecolor</code>. To view what actually changed in the data, we can un-<code>deflate</code> it using Python:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">zlib</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># before pngcrush (12 bytes)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08\xd7</span><span class="s1">c```</span><span class="se">\x00\x00\x00\x04\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># after pngcrush (10 bytes)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08\x1d</span><span class="s1">c`</span><span class="se">\x00\x00\x00\x02\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></td></tr></table></div>

<p>This makes sense since, according to the <a href="https://www.w3.org/TR/PNG/">PNG spec</a>, when using <code>truecolor</code>, each pixel is an RGB
triple, requiring 3 bytes. For <code>greyscale</code>, only a single byte representing luminance is needed. The
first byte is the filtering method, which isn't relevant here since we only have a single pixel.</p>
<p>Interestingly enough, in both cases we would actually be much better off if we could opt to <strong>not</strong> use
compression, but alas, the spec does not allow for anything except <code>deflate</code>.</p>
<p>But I digress, we now have a black 1x1 px PNG image that's just 67 bytes (<a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==">pixel.png</a>).</p>
<h2>Generating multiple unique small images</h2>
<p>So now we have the small PNG we want to display. Since the Chromecast's ambient mode requires at
least 2 different images in an album to cycle through, all we need to to do is upload 2 copies
of this PNG and we're done right? Almost.</p>
<p>Since Google Photos will automatically deduplicate uploaded images, we need to find a way to make
the second image slightly different. Normally this would involve tweaking a comment or something,
but in this case, the image has already been stripped down to its bare essentials.</p>
<p>My strategy was attempt to abuse the data compression to see if I could generate an image that
compressed the same data into the same number of bytes, but differently. Fortunately, <code>pngcrush</code> can
be told to use specific compression strategies (there are currently 177 of them). My hope is that at
least one of these will achieve the same results, but in a different way. For starters we'll try the
first 9:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">for</span><span class="w"> </span>x<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>seq<span class="w"> </span><span class="m">9</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>pngcrush<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$x</span><span class="s2">&quot;</span><span class="w"> </span>pixel.png<span class="w"> </span>pixel_alt<span class="si">${</span><span class="nv">x</span><span class="si">}</span>.png<span class="p">;</span>
<span class="k">done</span>
</code></pre></div></td></tr></table></div>

<p>A quick <code>ls -l</code> reveals that all of the <code>pixel_alt*.png</code> files are still 67 bytes. Now we just need
to find one that has different data. <code>sha1sum</code> is the perfect utility for this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>sha1sum<span class="w"> </span>pixel.png<span class="w"> </span>pixel_alt*.png
d99a9d63b1cd9e4b3f823d4d03144ccd95328f48<span class="w">  </span>pixel.png
7487dcce2b2bb81a442faf139b0a547bf070d5e2<span class="w">  </span>pixel_alt1.png
7487dcce2b2bb81a442faf139b0a547bf070d5e2<span class="w">  </span>pixel_alt2.png
7487dcce2b2bb81a442faf139b0a547bf070d5e2<span class="w">  </span>pixel_alt3.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1<span class="w">  </span>pixel_alt4.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1<span class="w">  </span>pixel_alt5.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1<span class="w">  </span>pixel_alt6.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1<span class="w">  </span>pixel_alt7.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1<span class="w">  </span>pixel_alt8.png
d99a9d63b1cd9e4b3f823d4d03144ccd95328f48<span class="w">  </span>pixel_alt9.png
</code></pre></div></td></tr></table></div>

<p><code>pixel_alt1.png</code> looks like a good candidate, let's see what changed:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>diff<span class="w"> </span>&lt;<span class="o">(</span>./pngview.py<span class="w"> </span>pixel.png<span class="o">)</span><span class="w"> </span>&lt;<span class="o">(</span>./pngview.py<span class="w"> </span>pixel_alt1.png<span class="o">)</span>
<span class="m">20</span>,21c20,21
&lt;<span class="w">             </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x08\x1dc`\x00\x00\x00\x02\x00\x01&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">10</span><span class="o">)</span>
&lt;<span class="w">             </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3486004709</span>
---
&gt;<span class="w">             </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>b<span class="s1">&#39;\x08[c`\x00\x00\x00\x02\x00\x01&#39;</span><span class="w"> </span><span class="o">(</span>total<span class="w"> </span><span class="m">10</span><span class="o">)</span>
&gt;<span class="w">             </span><span class="nv">crc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1648381800</span>
</code></pre></div></td></tr></table></div>

<p>There's the same amount of data, but it's different. Let's check if it decompresses to the same
image data:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">zlib</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08\x1d</span><span class="s1">c`</span><span class="se">\x00\x00\x00\x02\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">[c`</span><span class="se">\x00\x00\x00\x02\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></td></tr></table></div>

<p>Yep, this means that <a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIW2NgAAAAAgABYkBPaAAAAABJRU5ErkJggg==">pixel_alt1.png</a> is the exact same image with the exact same size, but won't
be deduplicated when uploading it to Google Photos since the compressed data is different.</p>
<h2>Final touches</h2>
<p>Now that we have 2 different tiny images, we can upload them to Google Photos and put them in an
album so they can be pulled down by the Chromecast. Something to note is that you may have to mark
the images as favorites to get them to be displayed. There seems to be some sort of AI-fueled "we
know better than you" algorithm that initially refused to display my images until I starred them.</p>
<p>Now just set your ambient mode to display the album with your images in it (or your favorites
album), set the slideshow speed to its maximum value (change image every 10 mins), and you're done.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/recovering-data-off-a-bootlooping-nexus5.html">Recovering data off a bootlooping Nexus 5</a></h1>
  </div>
  <div class="article_text">
    <h2>The situation</h2>
<p>The <a href="https://en.wikipedia.org/wiki/Nexus_5">Nexus 5</a> that I've had for almost 5 years started bootlooping repeatedly.</p>
<p>I've replaced/repaired multiple parts of it over the years but lately it had been more flaky than
usual. For example:</p>
<ul>
<li>Sometimes when booting it would show a "Firmware update in progress, don't disconnect your
   computer" message, even though there was nothing connected to the USB port.</li>
<li>It would randomly freeze and soft reboot when using it about once a week.</li>
<li>When propping it up on a book or something to angle the screen towards me, the screen would
   sometimes turn off and on (as it turns out, this was a warning sign)</li>
</ul>
<p>I've been ready to replace it for a while, but couldn't justify it while this one was perfectly (ok,
mostly) functional. That changed today when I tried to turn it on and it started bootlooping.</p>
<p>So buy a new phone and move on, right? Right, except I committed the cardinal sin of living in the
digital age - not having complete backups. Yeah, yeah, I know.</p>
<p>I got most of it. I'd been using <a href="https://github.com/pR0Ps/freeotp-export">Syncthing</a> to automatically back up photos, videos, and other
files to my home server every night so they were all good. The problem was that I had been using
<a href="https://github.com/pR0Ps/freeotp-export">FreeOTP-export</a> to back up my <a href="https://en.wikipedia.org/wiki/Multi-factor_authentication">2FA</a> secrets manually and the latest backup was missing a bunch
of logins.</p>
<p>So I needed to somehow get into my non-booting phone and pull the data off it. At least because I
was replacing it, all destructive options were on the table.</p>
<h2>Diagnosis</h2>
<p>The first step was seeing if other people had this problem. Some searching revealed that it was most
likely the power button gone bad and being stuck in the pressed position.</p>
<p>To confirm this, I rapidly hammered the power button on a hard surface while booting, hoping that
the jarring would un-stick it and let it boot. This sort of worked in that it would boot, but
stopping at any point would result it it powering off again. It was also extremely difficult to tap
it consistently enough to keep the phone on for long enough to pull any data off it.</p>
<p>The issue I mentioned earlier where propping the phone up made the screen turn on and off now made sense.
I'm guessing this was causing a slight flexing of the power button switch, causing it to close and
trigger. Over time this must've permanently bent something so it stayed closed, causing the
bootloop.</p>
<p>Now that I had pretty much confirmed that it was something physically wrong with the power button
circuitry, I messaged my friend <a href="https://mremallin.ca/">Mike</a>. When it comes to electronics, he's definitely more
experienced than me. Plus, he lets me borrow his tools :)</p>
<h2>The "fix"</h2>
<p>The next day Mike came over with his soldering iron and we started brainstorming.</p>
<p>The plan of attack was to just take the power button off the board entirely. It can't always be
pressed down if it's not on the board right?</p>
<p>In preparation for this, I wanted the phone to automatically boot when it was plugged into a charger
so I wouldn't have to manually short the pins on the board. Fortunately this can be done with a
fastboot command: <code>fastboot oem off-mode-charge 0</code> (basically: don't allow charging while off,
therefore turn on when charging).</p>
<p>After desoldering the power button from the main board, it was still bootlooping. Not good. I went
back and cleaned up the solder to make absolutely sure that the power button signal pins weren't
connected in any way. Still bootlooping when powered on. It would get to the bootloader and stay
there, meaning the power button wasn't being pressed anymore, but when launching to either recovery
or the main OS, it would immediately restart.</p>
<p>Looked into dumping data from the bootloader - impossible.</p>
<p>Reflashed the boot and recovery partitions - same thing.</p>
<p>Tried booting into recovery using <code>fastboot boot &lt;recovery-image&gt;</code> - bootloop.</p>
<blockquote>
<p>sounds like it's time to cry</p>
<p>-- Someone on <a href="https://webchat.freenode.net/?channels=#lineageos-dev">Freenode's #lineageos-dev channel</a> after I explained the situation</p>
</blockquote>
<p>Thankfully, it was not. Right after that, someone else asked if I had reconnected the battery. I had
not.</p>
<p>Turns out that a working battery is required to boot the phone, even when it's plugged in. I had
taken the battery out to desolder the power button and never put it back in since the phone seemed
to boot fine without it. Whoops.</p>
<p>After plugging the battery into the board and booting the phone, it launched the main OS without any
issues. Huge relief.</p>
<h2>Recovering the data</h2>
<p>With the phone booted up normally I used <code>adb</code> (running as root) to pull the 2FA codes and
other important things that I knew I needed over to my laptop.</p>
<p>I really don't trust myself to remember everything so I booted the phone into recovery mode and
pulled a complete backup of <code>/data/data</code>, <code>/data/app</code>, and <code>/storage/sdcard</code> (<a href="https://developer.android.com/guide/topics/data/data-storage.html#filesExternal">not actually an
sdcard</a>) to my laptop as well.</p>
<p>To make <strong>absolutely</strong> sure I didn't miss anything, I also pulled a raw image of the entire flash
memory (disk-based encryption was not enabled) using <code>adb pull /dev/block/mmcblk0 mmcblk0.img</code>.
Everything I need should be in the normal backups, but if not, I can always go spelunking through
that image.</p>
<h2>Lessons learned</h2>
<ul>
<li>If it's important, back it up <em>automatically</em>. If it's not automatic, at some point it will be
   missed.</li>
<li>Make sure you have the ability to get root access on every device you own before you need it - in
   this case I wouldn't've been able to pull the 2FA codes or do full backups without it.</li>
</ul>
<h2>Future plans</h2>
<p>For the Nexus 5, I'm planning on either buying a replacement power button or maybe just soldering
some wires to the exposed pads and snaking them out of the phone to an external button if I can't
find one. The phone can then continue to be used as an app development testbed, a <a href="https://store.google.com/product/chromecast">Chromecast</a>
remote, or as a <a href="../blog/adding-xbox360-controller-support-to-a-nexus5.html">basic emulation console</a> until it dies for real. In theory I could keep using it
as a phone too, but at this point I just don't trust it enough.</p>
<p>For my next phone, I've decided on the <a href="https://en.wikipedia.org/wiki/Sony_Xperia_XZ1_Compact">Xperia XZ1 Compact</a>. It's a smaller phone that's mostly
waterproof (<a href="https://en.wikipedia.org/wiki/IP_Code">IP68</a>), has a fast SoC (<a href="https://en.wikipedia.org/wiki/List_of_Qualcomm_Snapdragon_systems-on-chip#Snapdragon_835_and_845_(2017/18)">Snapdragon 835</a>), a headphone jack, SD card support, and
great battery life. I have high hopes for it. Also, as evidenced by this post, having root access to
the OS is pretty critical at times so I'll be flashing <a href="https://lineageos.org/">LineageOS</a> on it ASAP.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/password-recorvery-from-cellpipe-7130.html">Password recovery from an Alcatel-Lucent Cellpipe 7130</a></h1>
  </div>
  <div class="article_text">
    <h2>Background</h2>
<p>In my current rental situation, the landlord provides internet included with the rental. Since it's
fast enough and has enough bandwidth this isn't an issue at all. The only problem is that the modem
provided by the telco is an ancient <code>Alcatel-Lucent Cellpipe 7130 5VzA2001</code> modem/router combo. It's
running firmware version <code>1.0.4.4R8-wh</code>, released on 2012-05-08 16:30 (there are no updates, I
checked).</p>
<p>Since the Cellpipe only has 4 x 10/100 LAN ports and terrible WiFi performance, I would much prefer
to use my own equipment to perform the routing and just use the Cellpipe 7130 as a WAN gateway.
Unfortunately, for some reason, there is no way to turn off the routing aspect of the Cellpipe and
just use it as a modem (aka bridge mode). There is also no way to turn off <a href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a> functionality on
it.</p>
<p>My current hacky solution to these problems is to let my router get an IP from the modem/router via
DHCP, then set that IP as the DMZ host on the Cellpipe. This effectively forwards all TCP and UDP
ports to the router, making it seem like it's the boundary device for the network. Luckily, my
router always seems to request the same IP no matter what so this continues to work even if both
devices are power cycled.</p>
<p>Since this is not an ideal situation, I'd like to replace the Cellpipe with a more performant modem
without any of the routing overhead. To do this, I just need to port the configuration details from
the Cellpipe (like the username and password for the upstream <a href="https://en.wikipedia.org/wiki/Point-to-Point_Protocol_over_Ethernet">PPPoE</a> connection) over to a new
modem. Unfortunately, there's nothing in the web interface that will allow me to see the password
and there's no option to do a configuration backup. I also can't just call up the telco since it's
the landlord's account.</p>
<p>This means we're stuck, right?</p>
<h2>Digging into the Cellpipe</h2>
<p>Doing a quick <a href="https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures">CVE</a> search for the Cellpipe only turns up <a href="https://www.cvedetails.com/cve/CVE-2015-4586">CVE-2015-4586</a> (a <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a>
vulnerability) and <a href="https://www.cvedetails.com/cve/CVE-2015-4587">CVE-2015-4587</a> (an <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a> vulnerability), both of which aren't useful in this
case. Oh well.</p>
<p>Seeing as the <a href="https://infoproducts.alcatel-lucent.com/cgi-bin/dbaccessfilename.cgi/401389004_V1_CellPipe">Cellpipe 7130 manual</a>(PDF) mentions various functionality that my device
doesn't seem have, my hypothesis is that there might be a configuration backup/restore function
somewhere, just not exposed in the UI. With that in mind, I went trawling through the HTML and
JavaScript files the web UI served up. I found:</p>
<p>The color 'red' is commented out and redefined as white. This suggests that they could be hiding
error messages by just making them the same color as the background:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">//var red    =&#39;#FF0000&#39;;</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">red</span><span class="w">    </span><span class="o">=</span><span class="s1">&#39;#FFFFFF&#39;</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>

<p>Debugging in production builds with commented out <code>alert</code> statements:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">//alert(isRouter);</span>
<span class="c1">//alert(isAPmode);</span>
</code></pre></div></td></tr></table></div>

<p>Various comments indicating lack of source control:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">//Jamie hide 20111109</span>
<span class="cm">/*if(menuItem==&#39;HPNA&#39;)</span>
<span class="cm">{</span>
<span class="cm">    printMenuItem(&#39;hpna.html&#39;, &#39;HPNA&#39;, white, darkBlue);</span>
<span class="cm">}else{</span>
<span class="cm">    printMenuItem(&#39;hpna.html&#39;, &#39;HPNA&#39;, black, blue);</span>
<span class="cm">}</span>
<span class="cm">*/</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">//fanny add 2011/02/22</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;wifi_statistics.html&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;WLAN Statistics &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">black</span><span class="p">,</span><span class="w"> </span><span class="nx">white</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="cm">&lt;!-- jonathan 2004.04.07    Begin  --&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;logoutForm&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;logoutMsg&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="cm">&lt;!-- jonathan 2004.04.07    End  --&gt;</span>
</code></pre></div></td></tr></table></div>

<p>These all seem to allude to shoddy release processes, meaning that it's highly likely that
per-model customizations were rushed UI-level hack jobs on top of the current release and not
maintained branches where actual functionality was changed.</p>
<p>Since a configuration backup will include the PPPoE username and password, let's do a search for
"config". Sure enough:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nx">printMenuSection</span><span class="p">(</span><span class="s1">&#39;util_main.html&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Utilities&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">white</span><span class="p">);</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;lang_set.html&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Language Setting&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">black</span><span class="p">,</span><span class="nx">white</span><span class="p">);</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;util_reboot.html&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Reboot Gateway&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">black</span><span class="p">,</span><span class="nx">white</span><span class="p">);</span>
<span class="c1">//printMenuItem(&#39;util_reservice.html&#39;, &#39;Restart Service&#39;, black,white);</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;util_factory.html&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Restore Factory Defaults&#39;</span><span class="p">,</span><span class="nx">black</span><span class="p">,</span><span class="w"> </span><span class="nx">white</span><span class="p">);</span>
<span class="hll"><span class="c1">//printMenuItem(&#39;util_cfgstore.html&#39;, &#39;Configuration Store&#39;, black,white);</span>
</span><span class="hll"><span class="c1">//printMenuItem(&#39;util_cfgrestore.html&#39;, &#39;Configuration Restore&#39;, black,white);</span>
</span><span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;util_webfirmware.html&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Web Firmware Upload&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">black</span><span class="p">,</span><span class="nx">white</span><span class="p">);</span><span class="c1">//Jamie add back 20111109</span>
</code></pre></div></td></tr></table></div>

<p>Visiting <code>http://&lt;router_ip&gt;/util_cfgstore.html</code> shows a nice "Store" button that downloads a text
file containing 771(!) key/value pairs, including the username and password for the PPPoE connection.
Success!</p>
<h2>Future plans</h2>
<p>There are a ton of other options in the downloaded config file, some of which look like they enable
bridge mode. However, flipping those settings on and applying the new config using
<code>http://&lt;router_ip&gt;/util_cfgrestore.html</code> didn't seem to change anything. I'm going to keep messing
with it while I look into sourcing a better modem to use my newfound credentials with.</p>
<p>Longer-term, the plan is to transition to a dedicated modem that provides WAN access to a low-power
computer running <a href="https://www.pfsense.org/">pfSense</a> that handles firewall and routing duties. From there, an unmanaged
switch (possibly injecting <a href="https://en.wikipedia.org/wiki/Power_over_Ethernet">PoE</a>) can provide access for enough dumb wireless APs to bathe the
house in WiFi, as well as wired hookups for the devices that don't move around too much or need the
throughput. For now though, I'll settle for replacing the modem.</p>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
      <a href="../blog/index2.html"><i class="fa fa-arrow-circle-left"></i> Prev</a>
  </span>
  <span id="right">
      <a href="../blog/index4.html">Next <i class="fa fa-arrow-circle-right"></i></a>
  </span>
  <div>
      <a href="../blog/index.html"> 1 </a>
      <a href="../blog/index2.html"> 2 </a>
      <a href="../blog/index3.html">[3]</a>
      <a href="../blog/index4.html"> 4 </a>
      <a href="../blog/index5.html"> 5 </a>
      <a href="../blog/index6.html"> 6 </a>
      <a href="../blog/index7.html"> 7 </a>
      <a href="../blog/index8.html"> 8 </a>
      <a href="../blog/index9.html"> 9 </a>
      <a href="../blog/index10.html"> 10 </a>
      <a href="../blog/index11.html"> 11 </a>
      <a href="../blog/index12.html"> 12 </a>
      <a href="../blog/index13.html"> 13 </a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>