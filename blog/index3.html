<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts by Carey Metcalfe">

  <link rel="stylesheet" type="text/css" href="../theme/css/styles.425931e9.min.css">

  <script src="../theme/js/scripts.ab06d70e.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />

  <meta name="keywords" content="blog, carey, cmetcalfe, metcalfe, pr0ps, pr0pscm, android, application, automation, backup, chromecast, code, data recovery, electronics, email, games, git, hardware, iphone, let's encrypt, linux, macOS, mercurial, networking, png, proxmox, python, queen's university, router, security, shell script, sites, steam, vim, website, windows, wine">

  <title>Blog | Carey Metcalfe</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28306875-1', 'cmetcalfe.ca');
  ga('send', 'pageview');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href=".." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="..">Home</a>

      &#124; <a href="../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>
<a href="../blog/index.html">Posts</a>
&#124; <a href="../blog/tags/">Tags</a>
&#124; <a href="../blog/archives.html">Archive</a>
</p>    </header>

<article>
  <div class="article_title">
    <h1><a href="../blog/password-recorvery-from-cellpipe-7130.html">Password recovery from an Alcatel-Lucent Cellpipe 7130</a></h1>
  </div>
  <div class="article_text">
    <h2>Background</h2>
<p>In my current rental situation, the landlord provides internet included with the rental. Since it's
fast enough and has enough bandwidth this isn't an issue at all. The only problem is that the modem
provided by the telco is an ancient <code>Alcatel-Lucent Cellpipe 7130 5VzA2001</code> modem/router combo. It's
running firmware version <code>1.0.4.4R8-wh</code>, released on 2012-05-08 16:30 (there are no updates, I
checked).</p>
<p>Since the Cellpipe only has 4 x 10/100 LAN ports and terrible WiFi performance, I would much prefer
to use my own equipment to perform the routing and just use the Cellpipe 7130 as a WAN gateway.
Unfortunately, for some reason, there is no way to turn off the routing aspect of the Cellpipe and
just use it as a modem (aka bridge mode). There is also no way to turn off <a href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol">DHCP</a> functionality on
it.</p>
<p>My current hacky solution to these problems is to let my router get an IP from the modem/router via
DHCP, then set that IP as the DMZ host on the Cellpipe. This effectively forwards all TCP and UDP
ports to the router, making it seem like it's the boundary device for the network. Luckily, my
router always seems to request the same IP no matter what so this continues to work even if both
devices are power cycled.</p>
<p>Since this is not an ideal situation, I'd like to replace the Cellpipe with a more performant modem
without any of the routing overhead. To do this, I just need to port the configuration details from
the Cellpipe (like the username and password for the upstream <a href="https://en.wikipedia.org/wiki/Point-to-Point_Protocol_over_Ethernet">PPPoE</a> connection) over to a new
modem. Unfortunately, there's nothing in the web interface that will allow me to see the password
and there's no option to do a configuration backup. I also can't just call up the telco since it's
the landlord's account.</p>
<p>This means we're stuck, right?</p>
<h2>Digging into the Cellpipe</h2>
<p>Doing a quick <a href="https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures">CVE</a> search for the Cellpipe only turns up <a href="https://www.cvedetails.com/cve/CVE-2015-4586">CVE-2015-4586</a> (a <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a>
vulnerability) and <a href="https://www.cvedetails.com/cve/CVE-2015-4587">CVE-2015-4587</a> (an <a href="https://en.wikipedia.org/wiki/Cross-site_scripting">XSS</a> vulnerability), both of which aren't useful in this
case. Oh well.</p>
<p>Seeing as the <a href="https://infoproducts.alcatel-lucent.com/cgi-bin/dbaccessfilename.cgi/401389004_V1_CellPipe">Cellpipe 7130 manual</a>(PDF) mentions various functionality that my device
doesn't seem have, my hypothesis is that there might be a configuration backup/restore function
somewhere, just not exposed in the UI. With that in mind, I went trawling through the HTML and
JavaScript files the web UI served up. I found:</p>
<p>The color 'red' is commented out and redefined as white. This suggests that they could be hiding
error messages by just making them the same color as the background:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">//var red    =&#39;#FF0000&#39;;</span>
<span class="kd">var</span> <span class="nx">red</span>    <span class="o">=</span><span class="s1">&#39;#FFFFFF&#39;</span><span class="p">;</span>
</code></pre></div>
</td></tr></table>
<p>Debugging in production builds with commented out <code>alert</code> statements:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">//alert(isRouter);</span>
<span class="c1">//alert(isAPmode);</span>
</code></pre></div>
</td></tr></table>
<p>Various comments indicating lack of source control:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">//Jamie hide 20111109</span>
<span class="cm">/*if(menuItem==&#39;HPNA&#39;)</span>
<span class="cm">{</span>
<span class="cm">    printMenuItem(&#39;hpna.html&#39;, &#39;HPNA&#39;, white, darkBlue);</span>
<span class="cm">}else{</span>
<span class="cm">    printMenuItem(&#39;hpna.html&#39;, &#39;HPNA&#39;, black, blue);</span>
<span class="cm">}</span>
<span class="cm">*/</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c1">//fanny add 2011/02/22</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;wifi_statistics.html&#39;</span><span class="p">,</span> <span class="s1">&#39;WLAN Statistics &#39;</span><span class="p">,</span> <span class="nx">black</span><span class="p">,</span> <span class="nx">white</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="c">&lt;!-- jonathan 2004.04.07    Begin  --&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;logoutForm&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;logoutMsg&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="c">&lt;!-- jonathan 2004.04.07    End  --&gt;</span>
</code></pre></div>
</td></tr></table>
<p>These all seem to allude to shoddy release processes, meaning that it's highly likely that
per-model customizations were rushed UI-level hack jobs on top of the current release and not
maintained branches where actual functionality was changed.</p>
<p>Since a configuration backup will include the PPPoE username and password, let's do a search for
"config". Sure enough:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nx">printMenuSection</span><span class="p">(</span><span class="s1">&#39;util_main.html&#39;</span><span class="p">,</span> <span class="s1">&#39;Utilities&#39;</span><span class="p">,</span> <span class="nx">white</span><span class="p">);</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;lang_set.html&#39;</span><span class="p">,</span> <span class="s1">&#39;Language Setting&#39;</span><span class="p">,</span> <span class="nx">black</span><span class="p">,</span><span class="nx">white</span><span class="p">);</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;util_reboot.html&#39;</span><span class="p">,</span> <span class="s1">&#39;Reboot Gateway&#39;</span><span class="p">,</span> <span class="nx">black</span><span class="p">,</span><span class="nx">white</span><span class="p">);</span>
<span class="c1">//printMenuItem(&#39;util_reservice.html&#39;, &#39;Restart Service&#39;, black,white);</span>
<span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;util_factory.html&#39;</span><span class="p">,</span> <span class="s1">&#39;Restore Factory Defaults&#39;</span><span class="p">,</span><span class="nx">black</span><span class="p">,</span> <span class="nx">white</span><span class="p">);</span>
<span class="hll"><span class="c1">//printMenuItem(&#39;util_cfgstore.html&#39;, &#39;Configuration Store&#39;, black,white);</span>
</span><span class="hll"><span class="c1">//printMenuItem(&#39;util_cfgrestore.html&#39;, &#39;Configuration Restore&#39;, black,white);</span>
</span><span class="nx">printMenuItem</span><span class="p">(</span><span class="s1">&#39;util_webfirmware.html&#39;</span><span class="p">,</span> <span class="s1">&#39;Web Firmware Upload&#39;</span><span class="p">,</span> <span class="nx">black</span><span class="p">,</span><span class="nx">white</span><span class="p">);</span><span class="c1">//Jamie add back 20111109</span>
</code></pre></div>
</td></tr></table>
<p>Visiting <code>http://&lt;router_ip&gt;/util_cfgstore.html</code> shows a nice "Store" button that downloads a text
file containing 771(!) key/value pairs, including the username and password for the PPPoE connection.
Success!</p>
<h2>Future plans</h2>
<p>There are a ton of other options in the downloaded config file, some of which look like they enable
bridge mode. However, flipping those settings on and applying the new config using
<code>http://&lt;router_ip&gt;/util_cfgrestore.html</code> didn't seem to change anything. I'm going to keep messing
with it while I look into sourcing a better modem to use my newfound credentials with.</p>
<p>Longer-term, the plan is to transition to a dedicated modem that provides WAN access to a low-power
computer running <a href="https://www.pfsense.org/">pfSense</a> that handles firewall and routing duties. From there, an unmanaged
switch (possibly injecting <a href="https://en.wikipedia.org/wiki/Power_over_Ethernet">PoE</a>) can provide access for enough dumb wireless APs to bathe the
house in WiFi, as well as wired hookups for the devices that don't move around too much or need the
throughput. For now though, I'll settle for replacing the modem.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/forwarding-spam-with-gmail.html">Forwarding spam with Gmail</a></h1>
  </div>
  <div class="article_text">
    <p>With multiple Gmail accounts, it's often easier to forward all emails to a single main account that
you actually check. This can be accomplished by setting up a forwarding account in Gmail's settings.</p>
<p>However, something that isn't immediately obvious is that messages that are considered spam are
never forwarded. While Gmail's spam detection is extremely good, it's not perfect. There have been
times where emails that I actually wanted have ended up in the spam folder and weren't forwarded to
my main account.</p>
<p>To fix this, we want to tell Gmail to not flag anything as spam so it will be forwarded along.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This will <strong>not</strong> cause spam to appear in your inbox. It bypasses the spam filters so the email
is forwarded properly, but the account it's forwarded to will <em>also</em> flag the email as spam. The
end result is that that the email will end up in the spam folder of your main account (where you
can actually look at it) instead of not being forwarded from the original account at all.</p>
</div>
<p>We can do this with a filter that matches <code>is:spam</code> and applies the option "Never send it to Spam".
Unfortunately, Gmail's interface makes this task much harder than it needs to be.</p>
<ol>
<li>Open Gmail and do a search for <code>is:spam</code>. Notice that Gmail autocorrects it to <code>in:spam</code>.</li>
<li>Click the dropdown arrow on the right side of the search box to bring down the advanced options
   and click "Create filter with this search". Hit "OK" on the warning box that pops up. Notice that
   the filter has been autocorrected <em>again</em> to <code>label:spam</code>.</li>
<li>In the URL you should see something like <code>#create-filter/has=label%3Aspam</code>. Change <code>label</code> to
   <code>is</code> in the URL and hit enter. It should modify the text in the box without changing anything
   else.</li>
<li>Check the "Never send it to Spam" checkbox and hit "Create filter". You'll see the text get
   autocorrected to <code>in:spam</code> again, but if you check in Settings -&gt; Filters and Blocked Addresses
   you should see the correct <code>is:spam</code> filter.</li>
</ol>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/bank-of-canada-conversion-rates-terminal.html">Bank of Canada currency conversion rates in the terminal</a></h1>
  </div>
  <div class="article_text">
    <h1>Preface</h1>
<p>In this entry I'll use two command line tools (<a href="https://curl.haxx.se/"><code>curl</code></a> and <a href="https://stedolan.github.io/jq/"><code>jq</code></a>) to request currency
conversion rates from the <a href="https://www.bankofcanada.ca">Bank of Canada</a>. Now obviously getting the same data through the <a href="https://www.bankofcanada.ca/rates/exchange/daily-exchange-rates-lookup/">normal
web interface</a> is possible as well. However, doing it this way returns the data in a
machine-readable form, allowing it to be customized or used as input into other programs.</p>
<p>The basic flow will be request the data using <code>curl</code>, then pipe it to <code>jq</code> for processing.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This article will request the USD/CAD exchange rate from 2017-01-01 to 2017-01-10. It should be
fairly obvious how to switch this for any other currencies or date ranges. See the
<a href="#appendix">Appendix</a> for more information and caveats with the dates and the conversion codes.</p>
</div>
<p>We'll go from seeing the raw data the server returns to something that we can more easily use. <strong>To
skip to the final result, click <a href="#tldr">here</a></strong>.</p>
<div class="admonition update">
<p class="admonition-title">Update</p>
<p>The URLs for the data were originally reverse-engineered from the website. They have since been
turned into a supported API. See <a href="https://www.bankofcanada.ca/valet/docs">the API documentation</a> for more details.</p>
</div>
<h1>Lets go!</h1>
<p>Hitting the server without any processing will give the following result:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>curl -s <span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="nt">&quot;terms&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://www.bankofcanada.ca/terms/&quot;</span>
<span class="p">},</span>
<span class="nt">&quot;seriesDetail&quot;</span><span class="p">:{</span>
<span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="s2">&quot;USD/CAD&quot;</span><span class="p">,</span><span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;US dollar to Canadian dollar daily exchange rate&quot;</span><span class="p">}</span>
<span class="p">},</span>
<span class="nt">&quot;observations&quot;</span><span class="p">:[</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-02&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;e&quot;</span><span class="p">:</span><span class="mi">-64</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-03&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3435</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-04&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3315</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-05&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3244</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-06&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3214</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-09&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3240</span><span class="p">}},</span>
<span class="p">{</span><span class="nt">&quot;d&quot;</span><span class="p">:</span><span class="s2">&quot;2017-01-10&quot;</span><span class="p">,</span><span class="nt">&quot;FXUSDCAD&quot;</span><span class="p">:{</span><span class="nt">&quot;v&quot;</span><span class="p">:</span><span class="mf">1.3213</span><span class="p">}}</span>
<span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>To get the information we want, we need to iterate over the elements in the <code>observations</code> list and
map the date (<code>d</code>) to the conversion rate (<code>FXUSDCAD.v</code>). Since this will create a list of
single-element dictionaries, we'll also need to "add" (merge) them together.</p>
<p>To do this with <code>jq</code>, it looks like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>curl -s <span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span> <span class="p">|</span><span class="se">\</span>
jq <span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add</span>
<span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;2017-01-02&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-03&quot;</span><span class="p">:</span> <span class="mf">1.3435</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-04&quot;</span><span class="p">:</span> <span class="mf">1.3315</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-05&quot;</span><span class="p">:</span> <span class="mf">1.3244</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-06&quot;</span><span class="p">:</span> <span class="mf">1.3214</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-09&quot;</span><span class="p">:</span> <span class="mf">1.324</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-10&quot;</span><span class="p">:</span> <span class="mf">1.3213</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>That first <code>null</code> entry where there was no data is going to cause problems later, so let's just
delete it using the <code>del</code> function:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>curl -s <span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span> <span class="p">|</span><span class="se">\</span>
jq <span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add | del(.[] | nulls)</span>
<span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;2017-01-03&quot;</span><span class="p">:</span> <span class="mf">1.3435</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-04&quot;</span><span class="p">:</span> <span class="mf">1.3315</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-05&quot;</span><span class="p">:</span> <span class="mf">1.3244</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-06&quot;</span><span class="p">:</span> <span class="mf">1.3214</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-09&quot;</span><span class="p">:</span> <span class="mf">1.324</span><span class="p">,</span>
  <span class="nt">&quot;2017-01-10&quot;</span><span class="p">:</span> <span class="mf">1.3213</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>Now this may be good enough for most purposes, but it would be useful to compute some other
statistics from this data. For example, we want to know the average exchange rate for the date
range. Now that we have the data in an easy to use format, computing an average with <code>jq</code> is just a
matter of passing the values to an <code>add / length</code> filter. For example:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>curl -s <span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span> <span class="p">|</span><span class="se">\</span>
jq <span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add | del(.[] | nulls) | add / length</span>
<span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="mf">1.327683333333333</span>
</code></pre></div>
</td></tr></table>
<p><a name="tldr"></a>We can now construct an object that has both the average, as well as all the
data. Putting it all together we get:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>curl -s <span class="s2">&quot;https://www.bankofcanada.ca/valet/observations/FXUSDCAD/json?start_date=2017-01-01&amp;end_date=2017-01-10&quot;</span> <span class="p">|</span><span class="se">\</span>
jq <span class="s1">&#39;</span>
<span class="s1">    [.observations[] | {(.d) : .FXUSDCAD.v}] | add | del(.[] | nulls) |</span>
<span class="s1">    {</span>
<span class="s1">        &quot;average&quot;: (add / length),</span>
<span class="s1">        &quot;values&quot;: .</span>
<span class="s1">    }</span>
<span class="s1">&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;average&quot;</span><span class="p">:</span> <span class="mf">1.327683333333333</span><span class="p">,</span>
  <span class="nt">&quot;values&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;2017-01-03&quot;</span><span class="p">:</span> <span class="mf">1.3435</span><span class="p">,</span>
    <span class="nt">&quot;2017-01-04&quot;</span><span class="p">:</span> <span class="mf">1.3315</span><span class="p">,</span>
    <span class="nt">&quot;2017-01-05&quot;</span><span class="p">:</span> <span class="mf">1.3244</span><span class="p">,</span>
    <span class="nt">&quot;2017-01-06&quot;</span><span class="p">:</span> <span class="mf">1.3214</span><span class="p">,</span>
    <span class="nt">&quot;2017-01-09&quot;</span><span class="p">:</span> <span class="mf">1.324</span><span class="p">,</span>
    <span class="nt">&quot;2017-01-10&quot;</span><span class="p">:</span> <span class="mf">1.3213</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>And that's it! Hopefully you found this useful, if not for it's stated purpose of retrieving
exchange rates, then at least for getting more familiar with <code>jq</code>. It's pretty much the best tool
out there when it comes to manipulating JSON on the command line.</p>
<h1>Appendix<a name="appendix"></a></h1>
<h3>Date ranges</h3>
<ul>
<li>The server will only ever return data from <code>2017-01-03</code> and onwards. If the start range is before
  that, it doesn't return an error, it just doesn't return any data for those dates.</li>
<li>If the end date isn't specified, the server assumes the current date.</li>
<li>There doesn't seem to be any limit on the amount of data retrieved</li>
</ul>
<h3>Currency codes</h3>
<p>A list of codes can be easily scraped from the lookup page. The command and its result are below for
reference.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>curl -s <span class="s2">&quot;https://www.bankofcanada.ca/rates/exchange/daily-exchange-rates-lookup/&quot;</span> <span class="p">|</span> grep -Eo <span class="s1">&#39;&quot;FX......&quot;.*&lt;&#39;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>&quot;FXAUDCAD&quot;&gt;Australian dollar&lt;
&quot;FXBRLCAD&quot;&gt;Brazilian real&lt;
&quot;FXCNYCAD&quot;&gt;Chinese renminbi&lt;
&quot;FXEURCAD&quot;&gt;European euro&lt;
&quot;FXHKDCAD&quot;&gt;Hong Kong dollar&lt;
&quot;FXINRCAD&quot;&gt;Indian rupee&lt;
&quot;FXIDRCAD&quot;&gt;Indonesian rupiah&lt;
&quot;FXJPYCAD&quot;&gt;Japanese yen&lt;
&quot;FXMYRCAD&quot;&gt;Malaysian ringgit&lt;
&quot;FXMXNCAD&quot;&gt;Mexican peso&lt;
&quot;FXNZDCAD&quot;&gt;New Zealand dollar&lt;
&quot;FXNOKCAD&quot;&gt;Norwegian krone&lt;
&quot;FXPENCAD&quot;&gt;Peruvian new sol&lt;
&quot;FXRUBCAD&quot;&gt;Russian ruble&lt;
&quot;FXSARCAD&quot;&gt;Saudi riyal&lt;
&quot;FXSGDCAD&quot;&gt;Singapore dollar&lt;
&quot;FXZARCAD&quot;&gt;South African rand&lt;
&quot;FXKRWCAD&quot;&gt;South Korean won&lt;
&quot;FXSEKCAD&quot;&gt;Swedish krona&lt;
&quot;FXCHFCAD&quot;&gt;Swiss franc&lt;
&quot;FXTWDCAD&quot;&gt;Taiwanese dollar&lt;
&quot;FXTHBCAD&quot;&gt;Thai baht&lt;
&quot;FXTRYCAD&quot;&gt;Turkish lira&lt;
&quot;FXGBPCAD&quot;&gt;UK pound sterling&lt;
&quot;FXUSDCAD&quot;&gt;US dollar&lt;
&quot;FXVNDCAD&quot;&gt;Vietnamese dong&lt;
</code></pre></div>
</td></tr></table>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
      <a href="../blog/index2.html"><i class="fa fa-arrow-circle-left"></i> Prev</a>
  </span>
  <span id="right">
      <a href="../blog/index4.html">Next <i class="fa fa-arrow-circle-right"></i></a>
  </span>
  <div>
      <a href="../blog/index.html"> 1 </a>
      <a href="../blog/index2.html"> 2 </a>
      <a href="../blog/index3.html">[3]</a>
      <a href="../blog/index4.html"> 4 </a>
      <a href="../blog/index5.html"> 5 </a>
      <a href="../blog/index6.html"> 6 </a>
      <a href="../blog/index7.html"> 7 </a>
      <a href="../blog/index8.html"> 8 </a>
      <a href="../blog/index9.html"> 9 </a>
      <a href="../blog/index10.html"> 10 </a>
      <a href="../blog/index11.html"> 11 </a>
      <a href="../blog/index12.html"> 12 </a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>