<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Adding HTTPS support to this site | Yesterday I finally ticked something off my todo list that&#39;d been on there for a while - I added proper HTTPS support...">

  <link rel="stylesheet" type="text/css" href="../theme/css/styles.ec0bdb0f.min.css">

  <script src="../theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />

<meta name="keywords" content="blog, carey, cmetcalfe, metcalfe, pr0ps, pr0pscm, let's encrypt, security, website">

  <title>Adding HTTPS support to this site | Carey Metcalfe</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28306875-1', 'cmetcalfe.ca');
  ga('send', 'pageview');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href=".." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="..">Home</a>

      &#124; <a href="../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>
<a href="../blog/index.html">Posts</a>
&#124; <a href="../blog/tags/">Tags</a>
&#124; <a href="../blog/archives.html">Archive</a>
</p>    </header>

<article>
  <div class="article_title">
    <h1><a href="../blog/adding-https-support.html" class="nohover">Adding HTTPS support to this site</a></h1>
  </div>
  <div class="article_text">
    <p>Yesterday I finally ticked something off my todo list that'd been on there for a while - I added
proper HTTPS support to this site, powered by <a href="https://letsencrypt.org/">Let's Encrypt</a>.</p>
<p>The Qualys SSL Labs <a href="https://www.ssllabs.com/ssltest/index.html">SSL Server Test</a> now gives this site <a href="https://www.ssllabs.com/ssltest/analyze.html?d=cmetcalfe.ca">an A+ rating</a>. You can see all the
certs (past and present) for it on <a href="https://crt.sh/?q=cmetcalfe.ca">crt.sh</a>, an online certificate search tool.</p>
<h3>For those interested in how things work:</h3>
<p><a href="https://letsencrypt.org/">Let's Encrypt</a> is a "free, automated, and open" certificate authority. They provide certificates
via an <a href="https://letsencrypt.org/howitworks/technology/">automatable process</a> that are valid for <a href="https://letsencrypt.org/2015/11/09/why-90-days.html">90 days</a>.</p>
<p>Exactly how I got it all working can be seen in my <a href="https://github.com/pR0Ps/website">website repo</a>, where this entire site and it's
deployment scripts are kept, but here's the gist of it:</p>
<p>I decided to use <a href="https://github.com/lukas2511/dehydrated"><code>dehydrated</code></a> instead of the <a href="https://github.com/letsencrypt/letsencrypt">official Let's Encrypt client</a> to
generate the certificates. <code>dehydrated</code> is ~1000 lines of <code>bash</code> and only requires things like
<code>openssl</code>, <code>curl</code>, and a few other programs that any UNIX system should already have. It takes a
config file and a list of domains. Once those are in place running it from <code>cron</code> is easy.</p>
<p>The <a href="https://github.com/letsencrypt/acme-spec">ACME protocol</a> that Let's Encrypt uses to verify domain ownership requires the web server to
respond to certain requests. This check makes sure that only someone with control over the domain
can generate a cert for it. To allow those requests to return the files generated by <code>dehydrated</code>,
a <a href="https://github.com/pR0Ps/website/blob/8b3f9509e5f97522ac01789ca562409a7475cc60/web_config/https/letsencrypt.conf">location rule in the Nginx config</a> was added.</p>
<p>Initially there were problems with the first time generating certs. Since the certs didn't exist
yet, Nginx was failing to start (and therefore causing the domain validation to fail). The solution
was to make two sets of configs. An HTTP set, and an HTTPS set. During the renewal process, the HTTPS
configs are tried, and if running Nginx fails, it falls back to the HTTP set. Switching between HTTP
and HTTPS configs is done by modifying a symlink.</p>
<p>When all set up, this makes both generating a cert for the first time and renewing a cert as easy as
deploying the site. For continual, automated renewals, a monthly <code>cron</code> job was added. With the
expiry of certs being 90 days, this should be frequent enough that the certs should never expire.</p>
  </div>
<div class="article_meta">
  <p>Posted <time data-reltime datetime="2016-01-23T10:00:00-05:00">Jan 23, 2016</time>
   by Carey Metcalfe  </p>
  <p>
  Tags:
    <a href="../blog/tags/website.html">website</a>,    <a href="../blog/tags/security.html">security</a>,    <a href="../blog/tags/lets-encrypt.html">let's encrypt</a>  </p>
</div>
  <script src="https://giscus.app/client.js"
          data-repo="pR0Ps/cmetcalfe.ca"
          data-repo-id="MDEwOlJlcG9zaXRvcnkyNDUwNTQ4Njg="
          data-category="Announcements"
          data-category-id="DIC_kwDODps9lM4CTHc_"
          data-mapping="pathname"
          data-strict="0"
          data-reactions-enabled="1"
          data-emit-metadata="0"
          data-input-position="top"
          data-theme="light"
          data-lang="en"
          data-loading="lazy"
          crossorigin="anonymous"
          async>
  </script>
</article>


    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>

<script type="text/javascript">window.addEventListener("load", reltime);</script>
</body>
</html>