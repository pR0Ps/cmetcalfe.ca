<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts by Carey Metcalfe">

  <link rel="stylesheet" type="text/css" href="../theme/css/styles.425931e9.min.css">

  <script src="../theme/js/scripts.ab06d70e.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />

  <meta name="keywords" content="blog, carey, cmetcalfe, metcalfe, pr0ps, pr0pscm, android, application, audio, automation, backup, chromecast, code, data recovery, electronics, email, games, git, hardware, iphone, let's encrypt, linux, macOS, mercurial, networking, nvidia, png, proxmox, python, queen's university, router, security, shell script, sites, steam, vim, website, windows, wine">

  <title>Blog | Carey Metcalfe</title>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-28306875-1', 'cmetcalfe.ca');
  ga('send', 'pageview');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href=".." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="..">Home</a>

      &#124; <a href="../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>
<a href="../blog/index.html">Posts</a>
&#124; <a href="../blog/tags/">Tags</a>
&#124; <a href="../blog/archives.html">Archive</a>
</p>    </header>

<article>
  <div class="article_title">
    <h1><a href="../blog/diagnosing-periodic-high-ping-times-on-macos.html">Diagnosing periodic high ping times on macOS</a></h1>
  </div>
  <div class="article_text">
    <h2>Background</h2>
<p>Up until a few months ago, my home network setup was pretty terrible. The entire house ran off the
WiFi provided by an <a href="https://openwrt.org/">OpenWRT</a>-powered <a href="https://www.tp-link.com/us/products/details/TL-WDR3600.html">TP-Link WDR3600</a> from 2013 in the far corner of the
house. So when I fired up a game on my laptop via <a href="https://store.steampowered.com/streaming/">Steam in-home streaming</a> and got unplayable lag
and stuttering, I just figured that the issue was the network and left it at that. After all, the
gaming PC was connected via WiFI from the opposite corner of the house with no shortage of walls in
between.</p>
<p>In November 2018, I finally got serious about the network upgrade I had been planning. I'll probably
do a more in-depth post about this at some point, but to make a long story short: Most things are
wired and what isn't is connected via a modern, centrally-located access point. Performance is
noticeably better in general and <em>amazingly</em> better for high-bandwidth tasks like transferring
files.</p>
<p>So when I excitedly fired up the same game on my laptop, I was pretty surprised that it was still
unplayable. At this point I should clarify that the game was not something that requires a CRT and
wired controller for super-low response times. So when I say unplayable, I mean legitimately
unplayable. I'm talking periodic lag spikes that caused the video to drop a few seconds or more
behind the inputs. Even turn-based games would have issues with the amount of lag.</p>
<h2>Narrowing the scope</h2>
<p>To make sure it wasn't an issue with the streaming software, the gaming PC, or the network, I used
<code>ping</code> to test the latency to the gateway from a few hosts. All the computers <em>except</em> my laptop had
normal ping times. Running it on my laptop looked like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>$ ping pfsense.lan <span class="p">|</span> tee &gt;<span class="o">(</span>grep -oP <span class="s1">&#39;time=\K\S*&#39;</span> <span class="p">|</span> spark<span class="o">)</span>
PING pfsense.lan <span class="o">(</span><span class="m">192</span>.168.1.1<span class="o">)</span>: <span class="m">56</span> data bytes
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">0</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.574 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">0</span>.996 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.568 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">92</span>.153 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">39</span>.079 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">5</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">14</span>.307 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">6</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.570 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">7</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.636 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">8</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.698 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">9</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.568 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">10</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.550 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">11</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.106 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">12</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.832 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">13</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.816 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">14</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">36</span>.598 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">15</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">42</span>.863 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">16</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">20</span>.747 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">17</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">3</span>.112 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">18</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.695 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">19</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.795 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">20</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.504 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">21</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.644 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">22</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.732 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">23</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.581 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">24</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.794 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">25</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">33</span>.367 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">26</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">124</span>.282 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">27</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">97</span>.719 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">28</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">76</span>.501 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">29</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.734 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">30</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.622 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">31</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.758 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">32</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.578 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">33</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.527 ms
<span class="m">64</span> bytes from <span class="m">192</span>.168.1.1: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">34</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.017 ms
^C
 ▁▁▁▆▃▁▁▁▁▁▁▁▁▁▃▃▂▁▁▁▁▁▁▁▁▂█▆▅▁▁▁▁▁▁
</code></pre></div>
</td></tr></table>
<p>(sweet graph at the end courtesy of <a href="https://github.com/holman/spark/wiki/Wicked-Cool-Usage#visualize-ping-times-jnovinger">spark</a>)</p>
<p>Notice the periodic spikes. Clearly there's something going on with the network connection on my
laptop. Connecting via a wired connection and running it again confirmed that it was only happening
on WiFi.</p>
<h2>WiFi debugging</h2>
<p>Now that I had narrowed the issue down to an issue with the WiFi, I could start trying to debug it.</p>
<p>After coming across <a href="https://superuser.com/questions/585473/debugging-osx-airport-wifi-connection/735572#735572">this very helpful post</a> explaining how, I enabled WiFi debug logging by running:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>sudo /System/Library/PrivateFrameworks/Apple80211.framework/Versions/A/Resources/airport en0 debug +AllUserland
</code></pre></div>
</td></tr></table>
<p>(remember to turn this off after, <code>airport</code> is pretty chatty with debug logs enabled)</p>
<p>I then watched the wifi log (<code>sudo tail -f /var/log/wifi.log</code>) as I ran the same <code>ping</code> command.
Whenever I saw ping times spike, I also saw the following entries in the WiFi log:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.764 IPC: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; ADDED XPC CLIENT CONNECTION <span class="o">[</span>QSyncthingTray <span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>, <span class="nv">euid</span><span class="o">=</span><span class="m">501</span>, <span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.765 Info: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; SCAN request received from pid <span class="m">14397</span> <span class="o">(</span>QSyncthingTray<span class="o">)</span> with priority <span class="m">0</span>
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 Scan: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Cache-assisted scan request <span class="k">for</span> QSyncthingTray on channel <span class="m">1</span> does not require a live scan
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 Scan: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Cache-assisted scan request <span class="k">for</span> QSyncthingTray on channel <span class="m">2</span> does not require a live scan
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 Scan: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Cache-assisted scan request <span class="k">for</span> QSyncthingTray on channel <span class="m">3</span> does not require a live scan
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 Scan: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Cache-assisted scan request <span class="k">for</span> QSyncthingTray on channel <span class="m">4</span> does not require a live scan
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 Scan: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Cache-assisted scan request <span class="k">for</span> QSyncthingTray on channel <span class="m">5</span> does not require a live scan
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 Scan: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Cache-assisted scan request <span class="k">for</span> QSyncthingTray on channel <span class="m">6</span> does not require a live scan
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 Scan: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Cache-assisted scan request <span class="k">for</span> QSyncthingTray does not require a live scan
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 AutoJoin: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; Successful cache-assisted scan request <span class="k">for</span> QSyncthingTray with channels <span class="o">{(</span>
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766     &lt;CWChannel: 0x7f9073514e70&gt; <span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>2GHz<span class="o">)</span>, <span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>, active<span class="o">]</span>,
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766     &lt;CWChannel: 0x7f90735507b0&gt; <span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">2</span><span class="o">(</span>2GHz<span class="o">)</span>, <span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>, active<span class="o">]</span>,
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766     &lt;CWChannel: 0x7f9073526370&gt; <span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">3</span><span class="o">(</span>2GHz<span class="o">)</span>, <span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>, active<span class="o">]</span>,
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766     &lt;CWChannel: 0x7f9073526420&gt; <span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">4</span><span class="o">(</span>2GHz<span class="o">)</span>, <span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>, active<span class="o">]</span>,
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766     &lt;CWChannel: 0x7f907354ddb0&gt; <span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">5</span><span class="o">(</span>2GHz<span class="o">)</span>, <span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>, active<span class="o">]</span>,
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766     &lt;CWChannel: 0x7f907354c6c0&gt; <span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">6</span><span class="o">(</span>2GHz<span class="o">)</span>, <span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>, active<span class="o">]</span>
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.766 <span class="o">)}</span> took <span class="m">0</span>.0007 seconds, returned <span class="m">5</span> results
&lt; insert logs like above <span class="k">for</span> all channels all the way up to <span class="m">144</span> <span class="k">in</span> batches of <span class="m">6</span> &gt;
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:33.779 IPC: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; INVALIDATED XPC CLIENT CONNECTION <span class="o">[</span>QSyncthingTray <span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>, <span class="nv">euid</span><span class="o">=</span><span class="m">501</span>, <span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
&lt; <span class="m">10</span> seconds pass&gt;
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:43.847 IPC: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; ADDED XPC CLIENT CONNECTION <span class="o">[</span>QSyncthingTray <span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>, <span class="nv">euid</span><span class="o">=</span><span class="m">501</span>, <span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
&lt; same scanning logs as above &gt;
Tue Nov <span class="m">27</span> <span class="m">02</span>:01:46.741 IPC: &lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt; INVALIDATED XPC CLIENT CONNECTION <span class="o">[</span>QSyncthingTray <span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>, <span class="nv">euid</span><span class="o">=</span><span class="m">501</span>, <span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
&lt; ... and repeat &gt;
</code></pre></div>
</td></tr></table>
<p>This pretty clearly indicates that the <a href="https://github.com/sieren/QSyncthingTray">QSyncthingTray</a> application (a tray icon to monitor
<a href="https://syncthing.net/">Syncthing</a>) was periodically requesting WiFi scans which, in turn, caused the bursts of latency.
After quitting the application and running <code>ping</code> again, the times were all &lt;2ms, even after running
for a few minutes. Also, when I started up the game again to test it, the lag was completely gone!</p>
<h2>Digging deeper</h2>
<p>Since QSyncthingTray is open source, I filed a <a href="https://github.com/sieren/QSyncthingTray/issues/237">bug report</a> on the project and dug into the code
to see if I could pinpoint the issue. After finding nothing out of the ordinary and doing a bunch of
searching the internet, it turns out that it's not an issue with QSyncthingTray at all, but with
<a href="https://www.qt.io">Qt</a>, a cross-platform SDK that QSyncthingTray and many other programs use. Some classmates and I
actually used it to make a game called <a href="https://github.com/pR0Ps/ParticleStorm">ParticleStorm</a> back in university.</p>
<p>There are open bug reports against this issue from <a href="https://bugreports.qt.io/browse/QTBUG-34641">2013</a>, <a href="https://bugreports.qt.io/browse/QTBUG-40332">2014</a>, and <a href="https://bugreports.qt.io/browse/QTBUG-46015">2015</a>. Additionally,
there are loads of <a href="https://lostdomain.org/2017/06/17/qt-qnetworkaccessmanager-causing-latency-spikes-on-wifi/">blog</a> <a href="https://justus.berlin/2016/04/reducing-cpu-load-and-energy-consumption-of-texstudio-on-the-mac/">posts</a> and <a href="https://github.com/qbittorrent/qBittorrent/commit/c2b6e1ce1aa402b143d0154748c518a87bc6424a">per</a>-<a href="https://github.com/sqlitebrowser/sqlitebrowser/commit/73946400c32d1f7cfcd4672ab0ab3f563eb84f4e">program</a> <a href="https://github.com/KDE/krita/commit/19ba224692a52b1d5799fda308bed4b02ff38f7a">workarounds</a>. It's a little
disappointing that just running a network-enabled Qt application can seriously disrupt real-time
applications on the same system. Granted, I have no knowledge of the complexities of this issue, but
at the very least it seems <a href="https://doc.qt.io/qt-5/qnetworkconfigurationmanager.html">the documentation</a> could be clearer on the issue so developers stop
<a href="https://www.reddit.com/r/krita/comments/9xea9b/this_is_gonna_sound_crazy_but_is_krita/e9tfify/">getting surprised by it</a>.</p>
<p>Anyway, the "fix" is to set <code>QT_BEARER_POLL_TIMEOUT=-1</code> as an environment variable on your system.
Honestly, I've just stopped using QSyncthingTray instead. Not that it's not useful, I just realized
that I didn't really need it. Syncthing works well enough that I don't find myself ever worrying
about it. If a Qt application ever becomes an essential part of my setup I guess I'll have to
revisit this.</p>
<h2>Takeaways</h2>
<ol>
<li>
<p>When macOS scans for networks (as it does when requested by an application, when you click the WiFi
   icon, or when you request your location) it causes high ping times and dropped packets. According to
   bug reports, scanning for WiFi networks on other OS's causes the same issues. This is something I
   didn't really expect, but good to know going forward.</p>
</li>
<li>
<p>Qt has a bug where instantiating a <code>QNetworkConfigurationManager</code> causes it to scan for WiFi
   networks every 10 seconds by default. Some applications set the <code>QT_BEARER_POLL_TIMEOUT</code> environment
   variable themselves to disable this behaviour, but the majority probably have no idea that it's even
   an issue until a user reports it.</p>
</li>
</ol>
<p>So if you're seeing regular latency spikes, audit what programs you have running. Specifically look
for programs built with Qt. Setting the <code>QT_BEARER_POLL_TIMEOUT</code> environment variable to <code>-1</code> can
help with these. Applications that use your location <a href="https://apple.stackexchange.com/questions/263638/macbook-pro-experiencing-ping-spikes-to-local-router/317431#317431">could also be the culprit</a>. Who knew keeping
your ping down to an acceptable level was such a minefield...</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/proxied-access-to-namecheap-dns.html">Proxied access to the Namecheap DNS API</a></h1>
  </div>
  <div class="article_text">
    <h2>Background</h2>
<p>Both this site and my home server use HTTPS certificates provided by <a href="https://letsencrypt.org">Let's Encrypt</a>.
<a href="../blog/adding-https-support.html">Previously</a> I was using the <code>http-01</code> challenge method, but once <a href="https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579">wildcard
certificates became available</a>, I decided to switch to the <code>dns-01</code> method for simplicity.</p>
<p>My domains are currently registered through <a href="https://www.namecheap.com/">Namecheap</a> which provides an API for modifying DNS
records. The only catch is that it can only be accessed via manually-whitelisted IP addresses.
Because the server I'm trying to access the API from is assigned a dynamic IP, this restriction was
a bit of an issue.</p>
<p>Back in November when I initially made the switch to the DNS-based challenge, I set it up the easy
way: I manually added my current IP to the whitelist, added a TODO entry to fix it somehow, and set
a reminder scheduled for the week before the cert would expire telling me to update the IP
whitelist. Fast-forward to today when I was reminded to update my IP whitelist. Instead of
continuing to kick the can down the road, I decided to actually fix the issue.</p>
<h2>Setting up a temporary proxy</h2>
<p>My home server is connected to the internet though a normal residential connection which is assigned
a dynamic IP address. However, the server that I run this website on is configured with a static IP
since it's a hosted <a href="https://en.wikipedia.org/wiki/Virtual_private_server">VPS</a>. By proxying all traffic to the Namecheap API through my VPS, I could
add my VPS's static IP to the whitelist and not have to worry about my home IP changing all the
time.</p>
<p>SSH is perfect tool for this. The <a href="https://www.openssh.com/">OpenSSH client</a> supports port forwarding using the <code>-D</code> flag.
By then setting the <code>HTTP[S]_PROXY</code> environment variables to point to the forwarded port, programs
that support those environment variables will transparently forward all their requests through the
proxy.</p>
<p>After a bunch of research and testing, I came up with the following script to easily set up the
temporary proxy:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Source this file to automatically setup and teardown an HTTP* proxy through cmetcalfe.ca</span>
<span class="c1"># Use the PROXY_PORT and PROXY_DEST environment variables to customize the proxy</span>

<span class="nv">PROXY_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROXY_PORT</span><span class="k">:-</span><span class="nv">11111</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">PROXY_DEST</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROXY_DEST</span><span class="k">:-</span><span class="p">&lt;username&gt;@cmetcalfe.ca</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">PID</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$$</span><span class="s2">&quot;</span>

<span class="c1"># Teardown the SSH connection when the script exits</span>
<span class="nb">trap</span> <span class="s1">&#39;ssh -q -S &quot;.ctrl-socket-$PID&quot; -O exit &quot;$PROXY_DEST&quot;&#39;</span> EXIT

<span class="c1"># Set up an SSH tunnel and wait for the port to be forwarded before continuing</span>
<span class="k">if</span> ! ssh -o <span class="nv">ExitOnForwardFailure</span><span class="o">=</span>yes -M -S <span class="s2">&quot;.ctrl-socket-</span><span class="nv">$PID</span><span class="s2">&quot;</span> -f -N -D <span class="s2">&quot;</span><span class="nv">$PROXY_PORT</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$PROXY_DEST</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Failed to open SSH tunnel, exiting&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Set environment variables to redirect HTTP* traffic through the proxy</span>
<span class="nb">export</span> <span class="nv">HTTP_PROXY</span><span class="o">=</span><span class="s2">&quot;socks5://127.0.0.1:</span><span class="nv">$PROXY_PORT</span><span class="s2">&quot;</span>
<span class="nb">export</span> <span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HTTP_PROXY</span><span class="s2">&quot;</span>
</code></pre></div>
</td></tr></table>
<p>This script is saved as <code>~/.config/tempproxy.rc</code> and can be sourced to automatically set up a proxy
session and have it be torn down when the script exits.</p>
<p>You'll want to use key-based authentication with an unencrypted private key so that you don't need
to type anything to initiate the SSH session. For this reason you'll probably want to create a
limited user on the target system that can only really do port forwarding. There's a good post on
this <a href="https://askubuntu.com/questions/48129/how-to-create-a-restricted-ssh-user-for-port-forwarding/50000#50000">here</a>.</p>
<h2>Talking to the API through the proxy</h2>
<p>To allow programs that use the <code>tempproxy.rc</code> script to talk to the Namecheap API, the IP address of
the VPS was added to the whitelist. Now that the proxying issue was taken care of, I just needed
to wire up the actual certificate renewal process to use it.</p>
<p>The tool I'm using to talk to the Namecheap DNS API is <a href="https://github.com/AnalogJ/lexicon">lexicon</a>. It can handle manipulating the
DNS records of a ton of providers and integrates really nicely with my <a href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment">ACME</a> client of choice,
<a href="https://github.com/lukas2511/dehydrated">dehydrated</a>. Also, because it's using the <a href="https://github.com/Bemmu/PyNamecheap">PyNamecheap</a> Python library, which in turn uses
<a href="http://python-requests.org">requests</a> under the hood, it will <a href="http://docs.python-requests.org/en/master/user/advanced/#proxies">automatically use the <code>HTTP*_PROXY</code> environment
variables</a> when making requests.</p>
<p>The only tricky bit is that the base install of <code>lexicon</code> won't automatically pull in the packages
required for accessing the Namecheap API. Likewise, <code>requests</code> won't install packages to support
SOCKS proxies. To install all the required packages you'll need to run a command like:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>pip install <span class="s1">&#39;requests[socks]&#39;</span> <span class="s1">&#39;dns-lexicon[namecheap]&#39;</span>
</code></pre></div>
</td></tr></table>
<p>Since lexicon can use environment variables as configuration, I created another small source-able
file at <code>~/.config/lexicon.rc</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Sets environment variables for accessing the Namecheap API</span>

<span class="c1"># Turn on API access and get an API token here:</span>
<span class="c1"># https://ap.www.namecheap.com/settings/tools/apiaccess/</span>
<span class="nb">export</span> <span class="nv">PROVIDER</span><span class="o">=</span>namecheap
<span class="nb">export</span> <span class="nv">LEXICON_NAMECHEAP_USERNAME</span><span class="o">=</span>&lt;username&gt;
<span class="nb">export</span> <span class="nv">LEXICON_NAMECHEAP_TOKEN</span><span class="o">=</span>&lt;api token&gt;
</code></pre></div>
</td></tr></table>
<p>With that in place, the existing automation script that I had previously set up when I switched to
using the <code>dns-01</code> challenge just needed some minor tweaks to source the two new files. I've
provided the script below, along with some other useful ones that use the DNS API.</p>
<h2>Scripts</h2>
<h3><code>do-letsencrypt.sh</code></h3>
<p>This is the main script that handles all the domain renewals. It's called via <code>cron</code> on the first
of every month.</p>
<p>Fun fact: The previous <code>http-01</code> version of this script was a mess - it involved juggling <code>nginx</code>
configurations with symlinks, manually opening up the <code>.well-known/acme-challenge</code> endpoint, and
some other terrible hacks. This version is <em>much</em> nicer.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Generate/renew Let&#39;s Encrypt certificates using dehydrated and lexicon</span>

<span class="nb">set</span> -e

<span class="c1"># Set configuration variables and setup the proxy</span>
<span class="nb">source</span> ~/.config/lexicon.rc
<span class="nb">source</span> ~/.config/tempproxy.rc

<span class="nb">cd</span> /etc/nginx/ssl

<span class="c1"># Update the certs.</span>
<span class="c1"># Hook script copied verbatim from</span>
<span class="c1"># https://github.com/AnalogJ/lexicon/blob/master/examples/dehydrated.default.sh</span>
<span class="k">if</span> ! dehydrated --accept-terms --cron --challenge dns-01 --hook dehydrated.default.sh<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;Failed to renew certificates&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Reload the nginx config if it&#39;s currently running</span>
<span class="k">if</span> ! systemctl is-active nginx.service &gt; /dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;nginx isn&#39;t running, not reloading it&quot;</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="k">if</span> ! systemctl reload nginx.service<span class="p">;</span> <span class="k">then</span>
    systemctl status nginx.service
    <span class="nb">echo</span> <span class="s2">&quot;Failed to reload nginx config, check the error log&quot;</span>
    <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>
</code></pre></div>
</td></tr></table>
<h3><code>dns.sh</code></h3>
<p>This one is really simple - it just augments the normal lexicon CLI interface with the proxy and
configuration variables.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># A simple wrapper around lexicon.</span>
<span class="c1"># Sets up the proxy and configuration, then passes all the arguments to the configured provider</span>

<span class="nb">source</span> ~/.config/lexicon.rc
<span class="nb">source</span> ~/.config/tempproxy.rc
lexicon <span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div>
</td></tr></table>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>$ ./dns.sh list cmetcalfe.ca A
ID       TYPE NAME             CONTENT         TTL
-------- ---- ---------------- --------------- ----
xxxxxxxx A    @.cmetcalfe.ca   xxx.xxx.xxx.xxx <span class="m">1800</span>
xxxxxxxx A    www.cmetcalfe.ca xxx.xxx.xxx.xxx <span class="m">1800</span>
</code></pre></div>
</td></tr></table>
<h3><code>dns-update.sh</code></h3>
<p>An updated version of my <a href="../blog/dynamic-dns-client-for-namecheap.html">previous script</a> that uses the API instead of the
<a href="https://www.namecheap.com/support/knowledgebase/article.aspx/29/11/how-do-i-use-a-browser-to-dynamically-update-the-hosts-ip">DynamicDNS service Namecheap provides</a>. Called via <code>cron</code> every 30 minutes.</p>
<div class="admonition update">
<p class="admonition-title">Update</p>
<p>A previous version of this script didn't try to delete the DNS entry before setting the new one,
resulting in multiple IPs being set as the same <code>A</code> record.</p>
<p>This is because the <a href="https://github.com/AnalogJ/lexicon/blob/1feca5ead36cbf85ad92676dc853045e2c646097/lexicon/providers/namecheap.py#L233">update function of the Namecheap plugin for lexicon</a> is implemented as a
2-step delete and add. When it tries to delete the old record, it looks for one with the same
content as the old one. This means that if you update a record with a new IP, it doesn't find
the old record to delete first, leaving you with all of your old IPs set as individual A
records.</p>
</div>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Check the server&#39;s current IP against the IP listed in its DNS entry.</span>
<span class="c1"># Set the current IP if they differ.</span>

<span class="nb">set</span> -e

resolve<span class="o">()</span> <span class="o">{</span>
    <span class="nv">line</span><span class="o">=</span><span class="k">$(</span>drill <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> @resolver1.opendns.com <span class="m">2</span>&gt; /dev/null <span class="p">|</span> sed <span class="s1">&#39;/;;.*$/d;/^\s*$/d&#39;</span> <span class="p">|</span> grep <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="p">|</span> head -1 <span class="p">|</span> cut -f5
<span class="o">}</span>

<span class="nv">dns</span><span class="o">=</span><span class="k">$(</span>resolve &lt;subdomain&gt;.cmetcalfe.ca<span class="k">)</span>
<span class="nv">curr</span><span class="o">=</span><span class="k">$(</span>resolve myip.opendns.com<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$dns</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$curr</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">source</span> ~/.config/lexicon.rc
    <span class="nb">source</span> ~/.config/tempproxy.rc
    <span class="k">if</span> ! lexicon <span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span> delete cmetcalfe.ca A --name <span class="s2">&quot;&lt;subdomain&gt;.cmetcalfe.ca&quot;</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Failed to delete old DNS record, not setting the new one.&quot;</span>
        <span class="nb">exit</span> <span class="m">1</span>
    <span class="k">fi</span>
    <span class="k">if</span> lexicon <span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span> update cmetcalfe.ca A --name <span class="s2">&quot;&lt;subdomain&gt;.cmetcalfe.ca&quot;</span> --content <span class="s2">&quot;</span><span class="nv">$curr</span><span class="s2">&quot;</span> --ttl<span class="o">=</span><span class="m">900</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;Server DNS record updated (</span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&quot;Server DNS record update FAILED (tried </span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
    <span class="k">fi</span>
<span class="k">fi</span>
</code></pre></div>
</td></tr></table>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/reducing-chromecast-idle-bandwidth.html">Reducing Chromecast Idle Bandwidth</a></h1>
  </div>
  <div class="article_text">
    <p>Google's <a href="https://store.google.com/product/chromecast">Chromecast</a> is a pretty useful device. It plugs into the HDMI port of a TV and allows
users to "cast" content to it via a smartphone, <a href="https://www.google.com/chrome/">Chrome browser</a>, etc. This content is mostly
assumed to be streaming services like <a href="https://www.youtube.com/">Youtube</a>, <a href="https://www.spotify.com/">Spotify</a>, or <a href="https://www.netflix.com/">Netflix</a>, but for someone who
doesn't really buy into the whole cloud revolution like myself, it's still perfectly capable of
playing local content as well.</p>
<p>The one downside of the Chromecast is that when it's not being used, instead of going into a
low-power state and/or turning off the TV, it instead enters <a href="https://support.google.com/chromecast/answer/6080931">Ambient Mode</a>. This shows some
useful information overlaid on a changing backdrop of featured photos downloaded from <a href="https://photos.google.com/">Google
Photos</a>. The issue with this is that the images are high-resolution, not cached, and are
continually being downloaded 24/7 even when the TV is turned off. Although I haven't personally
measured it, the general consensus seems to be that it uses around 15GB of data per month from just
being plugged in.</p>
<p>What I'll be going over here is reducing the data the Chromecast uses by configuring it to only
download some tiny black 1x1 px images to use as a backdrop.</p>
<h2>The short version</h2>
<ul>
<li>Make a tiny black PNG (<a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==">pixel.png</a>)</li>
<li>Make a slightly different tiny PNG to avoid deduplication (<a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIW2NgAAAAAgABYkBPaAAAAABJRU5ErkJggg==">pixel_alt1.png</a>)</li>
<li>Upload both to an album in Google Photos</li>
<li>Mark both images as favorites</li>
<li>Configure the Chromecast to only pull images from your specific album every 10 minutes</li>
</ul>
<p>If you like details, keep reading...</p>
<h2>Making a small image</h2>
<p>I ended up creating a 1x1 solid black image in GIMP, saving it as a PNG, hacking out as much data as
possible using a hex editor, then using <a href="https://pmt.sourceforge.io/pngcrush/"><code>pngcrush</code></a> to attempt to optimize the data
that was left.</p>
<p>As I was working on the PNG file, I used a small script based on the Python <a href="https://construct.readthedocs.io/en/latest/">construct</a> library to
visualize the chunks and structure of it so I could figure out what to cut.</p>
<p>To install <code>construct</code> and download the example PNG specification:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>python3 -m venv .venv
<span class="nb">source</span> .venv/bin/activate
pip install construct
wget <span class="s2">&quot;https://raw.githubusercontent.com/construct/construct/abd48c4892ceddc60c11d25f4a955573e2c61111/deprecated_gallery/png.py&quot;</span>
</code></pre></div>
</td></tr></table>
<p>Create <code>pngview.py</code>:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">png</span>  <span class="c1"># the png spec downloaded above</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Size:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s2">&quot;bytes&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">png</span><span class="o">.</span><span class="n">png_file</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</code></pre></div>
</td></tr></table>
<p>Running it on the PNG exported from GIMP using the default settings gives:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>$ ./pngview.py pixel.png
Size: <span class="m">146</span> bytes
Container: 
    <span class="nv">signature</span> <span class="o">=</span> b<span class="s1">&#39;\x89PNG\r\n\x1a\n&#39;</span> <span class="o">(</span>total <span class="m">8</span><span class="o">)</span>
    <span class="nv">image_header</span> <span class="o">=</span> Container: 
        <span class="nv">length</span> <span class="o">=</span> <span class="m">13</span>
        <span class="nv">signature</span> <span class="o">=</span> b<span class="s1">&#39;IHDR&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
        <span class="nv">width</span> <span class="o">=</span> <span class="m">1</span>
        <span class="nv">height</span> <span class="o">=</span> <span class="m">1</span>
        <span class="nv">bit_depth</span> <span class="o">=</span> <span class="m">8</span>
        <span class="nv">color_type</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> truecolor <span class="m">2</span>
        <span class="nv">compression_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> deflate <span class="m">0</span>
        <span class="nv">filter_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> adaptive5 <span class="m">0</span>
        <span class="nv">interlace_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> none <span class="m">0</span>
        <span class="nv">crc</span> <span class="o">=</span> <span class="m">2423739358</span>
    <span class="nv">chunks</span> <span class="o">=</span> ListContainer: 
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">9</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;pHYs&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> Container: 
                <span class="nv">pixels_per_unit_x</span> <span class="o">=</span> <span class="m">11811</span>
                <span class="nv">pixels_per_unit_y</span> <span class="o">=</span> <span class="m">11811</span>
                <span class="nv">unit</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> meter <span class="m">1</span>
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">2024095606</span>
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">7</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;tIME&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> Container: 
                <span class="nv">year</span> <span class="o">=</span> <span class="m">2018</span>
                <span class="nv">month</span> <span class="o">=</span> <span class="m">12</span>
                <span class="nv">day</span> <span class="o">=</span> <span class="m">11</span>
                <span class="nv">hour</span> <span class="o">=</span> <span class="m">5</span>
                <span class="nv">minute</span> <span class="o">=</span> <span class="m">2</span>
                <span class="nv">second</span> <span class="o">=</span> <span class="m">19</span>
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">904567710</span>
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">25</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;tEXt&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> Container: 
                <span class="nv">keyword</span> <span class="o">=</span> u<span class="s1">&#39;Comment&#39;</span> <span class="o">(</span>total <span class="m">7</span><span class="o">)</span>
                <span class="nv">text</span> <span class="o">=</span> b<span class="s1">&#39;Created with GIM&#39;</span>... <span class="o">(</span>truncated, total <span class="m">17</span><span class="o">)</span>
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">1468075543</span>
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">12</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;IDAT&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> b<span class="s1">&#39;\x08\xd7c```\x00\x00\x00\x04\x00\x01&#39;</span> <span class="o">(</span>total <span class="m">12</span><span class="o">)</span>
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">657729290</span>
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">0</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;IEND&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> None
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">2923585666</span>
</code></pre></div>
</td></tr></table>
<p>After removing the unneeded <code>pHYs</code>, <code>tIME</code>, and <code>tEXt</code> chunks using a hex editor, it looks like this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>$ ./pngview.py pixel.png 
Size: <span class="m">69</span> bytes
Container: 
    <span class="nv">signature</span> <span class="o">=</span> b<span class="s1">&#39;\x89PNG\r\n\x1a\n&#39;</span> <span class="o">(</span>total <span class="m">8</span><span class="o">)</span>
    <span class="nv">image_header</span> <span class="o">=</span> Container: 
        <span class="nv">length</span> <span class="o">=</span> <span class="m">13</span>
        <span class="nv">signature</span> <span class="o">=</span> b<span class="s1">&#39;IHDR&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
        <span class="nv">width</span> <span class="o">=</span> <span class="m">1</span>
        <span class="nv">height</span> <span class="o">=</span> <span class="m">1</span>
        <span class="nv">bit_depth</span> <span class="o">=</span> <span class="m">8</span>
        <span class="nv">color_type</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> truecolor <span class="m">2</span>
        <span class="nv">compression_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> deflate <span class="m">0</span>
        <span class="nv">filter_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> adaptive5 <span class="m">0</span>
        <span class="nv">interlace_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> none <span class="m">0</span>
        <span class="nv">crc</span> <span class="o">=</span> <span class="m">2423739358</span>
    <span class="nv">chunks</span> <span class="o">=</span> ListContainer: 
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">12</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;IDAT&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> b<span class="s1">&#39;\x08\xd7c```\x00\x00\x00\x04\x00\x01&#39;</span> <span class="o">(</span>total <span class="m">12</span><span class="o">)</span>
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">657729290</span>
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">0</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;IEND&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> None
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">2923585666</span>
</code></pre></div>
</td></tr></table>
<p>At this point, all that's left to optimize is the image data itself. This is where <code>pngcrush</code>
shines. After running <code>pngcrush -brute -ow pixel.png</code> we see:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>$ ./pngview.py pixel.png
Size: <span class="m">67</span> bytes
Container: 
    <span class="nv">signature</span> <span class="o">=</span> b<span class="s1">&#39;\x89PNG\r\n\x1a\n&#39;</span> <span class="o">(</span>total <span class="m">8</span><span class="o">)</span>
    <span class="nv">image_header</span> <span class="o">=</span> Container: 
        <span class="nv">length</span> <span class="o">=</span> <span class="m">13</span>
        <span class="nv">signature</span> <span class="o">=</span> b<span class="s1">&#39;IHDR&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
        <span class="nv">width</span> <span class="o">=</span> <span class="m">1</span>
        <span class="nv">height</span> <span class="o">=</span> <span class="m">1</span>
        <span class="nv">bit_depth</span> <span class="o">=</span> <span class="m">8</span>
        <span class="nv">color_type</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> greyscale <span class="m">0</span>
        <span class="nv">compression_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> deflate <span class="m">0</span>
        <span class="nv">filter_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> adaptive5 <span class="m">0</span>
        <span class="nv">interlace_method</span> <span class="o">=</span> <span class="o">(</span>enum<span class="o">)</span> none <span class="m">0</span>
        <span class="nv">crc</span> <span class="o">=</span> <span class="m">981375829</span>
    <span class="nv">chunks</span> <span class="o">=</span> ListContainer: 
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">10</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;IDAT&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> b<span class="s1">&#39;\x08\x1dc`\x00\x00\x00\x02\x00\x01&#39;</span> <span class="o">(</span>total <span class="m">10</span><span class="o">)</span>
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">3486004709</span>
        Container: 
            <span class="nv">length</span> <span class="o">=</span> <span class="m">0</span>
            <span class="nb">type</span> <span class="o">=</span> b<span class="s1">&#39;IEND&#39;</span> <span class="o">(</span>total <span class="m">4</span><span class="o">)</span>
            <span class="nv">data</span> <span class="o">=</span> None
            <span class="nv">crc</span> <span class="o">=</span> <span class="m">2923585666</span>
</code></pre></div>
</td></tr></table>
<p>The 2 byte savings in the data seem to have come from setting the <code>color_type</code> to <code>greyscale</code>
instead of <code>truecolor</code>. To view what actually changed in the data, we can un-<code>deflate</code> it using Python:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">zlib</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># before pngcrush (12 bytes)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08\xd7</span><span class="s1">c```</span><span class="se">\x00\x00\x00\x04\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c1"># after pngcrush (10 bytes)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08\x1d</span><span class="s1">c`</span><span class="se">\x00\x00\x00\x02\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div>
</td></tr></table>
<p>This makes sense since, according to the <a href="https://www.w3.org/TR/PNG/">PNG spec</a>, when using <code>truecolor</code>, each pixel is an RGB
triple, requiring 3 bytes. For <code>greyscale</code>, only a single byte representing luminance is needed. The
first byte is the filtering method, which isn't relevant here since we only have a single pixel.</p>
<p>Interestingly enough, in both cases we would actually be much better off if we could opt to <strong>not</strong> use
compression, but alas, the spec does not allow for anything except <code>deflate</code>.</p>
<p>But I digress, we now have a black 1x1 px PNG image that's just 67 bytes (<a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIHWNgAAAAAgABz8g15QAAAABJRU5ErkJggg==">pixel.png</a>).</p>
<h2>Generating multiple unique small images</h2>
<p>So now we have the small PNG we want to display. Since the Chromecast's ambient mode requires at
least 2 different images in an album to cycle through, all we need to to do is upload 2 copies
of this PNG and we're done right? Almost.</p>
<p>Since Google Photos will automatically deduplicate uploaded images, we need to find a way to make
the second image slightly different. Normally this would involve tweaking a comment or something,
but in this case, the image has already been stripped down to its bare essentials.</p>
<p>My strategy was attempt to abuse the data compression to see if I could generate an image that
compressed the same data into the same number of bytes, but differently. Fortunately, <code>pngcrush</code> can
be told to use specific compression strategies (there are currently 177 of them). My hope is that at
least one of these will achieve the same results, but in a different way. For starters we'll try the
first 9:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="k">for</span> x <span class="k">in</span> <span class="k">$(</span>seq <span class="m">9</span><span class="k">)</span><span class="p">;</span> <span class="k">do</span>
    pngcrush -m <span class="s2">&quot;</span><span class="nv">$x</span><span class="s2">&quot;</span> pixel.png pixel_alt<span class="si">${</span><span class="nv">x</span><span class="si">}</span>.png<span class="p">;</span>
<span class="k">done</span>
</code></pre></div>
</td></tr></table>
<p>A quick <code>ls -l</code> reveals that all of the <code>pixel_alt*.png</code> files are still 67 bytes. Now we just need
to find one that has different data. <code>sha1sum</code> is the perfect utility for this:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>$ sha1sum pixel.png pixel_alt*.png
d99a9d63b1cd9e4b3f823d4d03144ccd95328f48  pixel.png
7487dcce2b2bb81a442faf139b0a547bf070d5e2  pixel_alt1.png
7487dcce2b2bb81a442faf139b0a547bf070d5e2  pixel_alt2.png
7487dcce2b2bb81a442faf139b0a547bf070d5e2  pixel_alt3.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1  pixel_alt4.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1  pixel_alt5.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1  pixel_alt6.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1  pixel_alt7.png
c3ea09bfcfcb36ce22d3f19eacada359f3984ed1  pixel_alt8.png
d99a9d63b1cd9e4b3f823d4d03144ccd95328f48  pixel_alt9.png
</code></pre></div>
</td></tr></table>
<p><code>pixel_alt1.png</code> looks like a good candidate, let's see what changed:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code>$ diff &lt;<span class="o">(</span>./pngview.py pixel.png<span class="o">)</span> &lt;<span class="o">(</span>./pngview.py pixel_alt1.png<span class="o">)</span>
<span class="m">20</span>,21c20,21
&lt;             <span class="nv">data</span> <span class="o">=</span> b<span class="s1">&#39;\x08\x1dc`\x00\x00\x00\x02\x00\x01&#39;</span> <span class="o">(</span>total <span class="m">10</span><span class="o">)</span>
&lt;             <span class="nv">crc</span> <span class="o">=</span> <span class="m">3486004709</span>
---
&gt;             <span class="nv">data</span> <span class="o">=</span> b<span class="s1">&#39;\x08[c`\x00\x00\x00\x02\x00\x01&#39;</span> <span class="o">(</span>total <span class="m">10</span><span class="o">)</span>
&gt;             <span class="nv">crc</span> <span class="o">=</span> <span class="m">1648381800</span>
</code></pre></div>
</td></tr></table>
<p>There's the same amount of data, but it's different. Let's check if it decompresses to the same
image data:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">zlib</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08\x1d</span><span class="s1">c`</span><span class="se">\x00\x00\x00\x02\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x08</span><span class="s1">[c`</span><span class="se">\x00\x00\x00\x02\x00\x01</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\x00</span><span class="s1">&#39;</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div>
</td></tr></table>
<p>Yep, this means that <a href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAAAAAA6fptVAAAACklEQVQIW2NgAAAAAgABYkBPaAAAAABJRU5ErkJggg==">pixel_alt1.png</a> is the exact same image with the exact same size, but won't
be deduplicated when uploading it to Google Photos since the compressed data is different.</p>
<h2>Final touches</h2>
<p>Now that we have 2 different tiny images, we can upload them to Google Photos and put them in an
album so they can be pulled down by the Chromecast. Something to note is that you may have to mark
the images as favorites to get them to be displayed. There seems to be some sort of AI-fueled "we
know better than you" algorithm that initially refused to display my images until I starred them.</p>
<p>Now just set your ambient mode to display the album with your images in it (or your favorites
album), set the slideshow speed to its maximum value (change image every 10 mins), and you're done.</p>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
      <a href="../blog/index.html"><i class="fa fa-arrow-circle-left"></i> Prev</a>
  </span>
  <span id="right">
      <a href="../blog/index3.html">Next <i class="fa fa-arrow-circle-right"></i></a>
  </span>
  <div>
      <a href="../blog/index.html"> 1 </a>
      <a href="../blog/index2.html">[2]</a>
      <a href="../blog/index3.html"> 3 </a>
      <a href="../blog/index4.html"> 4 </a>
      <a href="../blog/index5.html"> 5 </a>
      <a href="../blog/index6.html"> 6 </a>
      <a href="../blog/index7.html"> 7 </a>
      <a href="../blog/index8.html"> 8 </a>
      <a href="../blog/index9.html"> 9 </a>
      <a href="../blog/index10.html"> 10 </a>
      <a href="../blog/index11.html"> 11 </a>
      <a href="../blog/index12.html"> 12 </a>
      <a href="../blog/index13.html"> 13 </a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>