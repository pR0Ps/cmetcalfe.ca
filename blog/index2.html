<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Carey Metcalfe">
  <meta name="description" content="Posts by Carey Metcalfe">

  <link rel="stylesheet" type="text/css" href="../theme/css/styles.ec0bdb0f.min.css">

  <script src="../theme/js/scripts.7db5858b.min.js" type="text/javascript"></script>

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">

  <link href="https://cmetcalfe.ca/feeds/all.rss" type="application/rss+xml" rel="alternate" title="Carey Metcalfe Full RSS Feed" />

  <meta name="keywords" content="blog, carey, cmetcalfe, metcalfe, pr0ps, pr0pscm, android, application, audio, automation, backup, canada, chromecast, code, data recovery, electronics, email, games, git, hardware, homelab, iphone, let's encrypt, linux, macOS, mercurial, networking, nvidia, png, proxmox, python, queen's university, router, security, shell script, sites, steam, vim, website, windows, wine">

  <title>Blog | Carey Metcalfe</title>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-DXC76BHD2F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DXC76BHD2F');
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="..">
        <img src="/images/avatar.jpg" id="logo">
      </a>
      <h2><a href=".." class="nohover">Carey Metcalfe</a></h2>
      <p>Software Developer</p>
      <div class="social">
          <a data-email="ac.eflactemc@yerac:otliam" data-title="Email" title="You need javascript enabled to view this email" class="email" target="_blank" rel="noopener noreferrer"><i class="fa fa-envelope fa-lg"></i></a>
          <a href="https://github.com/pR0Ps" title="GitHub" target="_blank" rel="noopener noreferrer"><i class="fa fa-github fa-lg"></i></a>
          <a href="https://twitter.com/CareyMetcalfe" title="Twitter" target="_blank" rel="noopener noreferrer"><i class="fa fa-twitter fa-lg"></i></a>
      </div>
      <ul>
      </ul>
    </div>
  </aside>

  <main id="main">
    <header>
      <p id="header">
      <a href="..">Home</a>

      &#124; <a href="../blog/index.html">Blog</a>
      &#124; <a href="https://cmetcalfe.ca/feeds/all.rss">RSS Feed</a>
      </p>
<p>
<a href="../blog/index.html">Posts</a>
&#124; <a href="../blog/tags/">Tags</a>
&#124; <a href="../blog/archives.html">Archive</a>
</p>    </header>

<article>
  <div class="article_title">
    <h1><a href="../blog/disabling-emergency-alerts-on-android.html">Disabling emergency alerts on Android</a></h1>
  </div>
  <div class="article_text">
    <div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You probably shouldn't do this. If you already know this and don't care, read on.</p>
</div>
<h2>Background</h2>
<p>In Canada, the <a href="https://crtc.gc.ca/">CRTC</a> mandates that telecommunications companies and other organizations broadcast
warning messages over various mediums, one of which is via cell phones.</p>
<p>Overall, this is a good idea that saves lives. However, the implementation is incredibly bad. All
alerts, no matter the severity, are broadcast at the very highest level (called "Presidential" by
Android phones), meaning that they can't be silenced or disabled by the user. In fact, the CRTC
actually <a href="https://crtc.gc.ca/eng/publications/reports/alertmobil/alertmobil.htm#a13">tested this</a> and
found that the only reliable way to silence the alerts was to put the phone on airplane mode.</p>
<p>After I received three alerts all about an hour apart starting at 2am telling me about a missing
child over 1,300km away, I'd had enough.</p>
<p>This is a "boy who cried wolf" situation here. If these alerts ever:</p>
<ol>
<li>Implement a basic distance filter so I'm not woken up by things happening nowhere near me</li>
<li>Start using an appropriate alert level instead of using the highest level for everything</li>
</ol>
<p>I'll re-enable them. For now though, I don't want to be repeatedly woken up in the middle of the
night because someone a full day's drive from me went missing. Maybe that's cold-hearted, but
realistically what was I even going to do about it?</p>
<p>On Android at least, the lower-level emergency alerts can be configured to not make noise when the
device is silenced, but not disabled entirely. This seems a lot better as it won't wake people up,
but will show them the information the next time they look at the phone. Let's do that instead.</p>
<p>For now though, I'm turning everything off. Hopefully I don't get killed by a tornado or something.</p>
<h2>How to disable ALL alerts</h2>
<p>This is surprisingly simple - the application responsible for handling the broadcasts can be
uninstalled.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This will disable ALL emergency broadcasts. If you live in an area that regularly has severe
weather or don't have a backup method for receiving these alerts, this is definitely not a good
idea. It also probably violates some sort of policy or something (not a lawyer). You are
responsible for your own decisions.</p>
</div>
<p>To uninstall it, enable developer options and debugging on the phone, connect it to a computer with
<a href="http://developer.android.com/tools/help/adb.html">ADB</a> installed and run:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>adb<span class="w"> </span>-d<span class="w"> </span>shell<span class="w"> </span><span class="s2">&quot;pm uninstall -k com.android.cellbroadcastreceiver&quot;</span>
</code></pre></div></td></tr></table></div>

<p>Thanks to <a href="https://web.archive.org/web/20230420065952/https://www.reddit.com/r/ontario/comments/boxx11/how_to_disable_amber_alerts/">this reddit post</a> for the method of disabling
the alerts.</p>
<h2>Why is it like this?</h2>
<p>Which organization is responsible? Can this be changed?</p>
<p>Below is a rough dump of some details I found while trying to dig up which organization is
responsible for this with the hopes of actually affecting some change.</p>
<p>On 2017-04-06 the <a href="https://crtc.gc.ca/">CRTC</a> issued <a href="https://crtc.gc.ca/eng/archive/2017/2017-91.htm">Telecom Regulatory Policy CRTC 2017-91</a> which "directs wireless
service providers to implement wireless public alerting capability on their long-term evolution
networks by 6 April 2018". Relevant information pulled from that page:</p>
<blockquote>
<p>34. SOREM has established a definitive list of emergency alert message types for immediate
    broadcast by alert distributors. These messages are defined as “Broadcast Immediately” (BI).</p>
</blockquote>
<p>In a footnote on the page it defines SOREM as:</p>
<blockquote>
<p>SOREM is a federal/provincial/territorial body that works to harmonize and improve emergency
practices across the country. It includes representatives from provincial and territorial
emergency management organizations as well as Public Safety Canada.</p>
</blockquote>
<p>There was some disagreement on making the alerts mandatory:</p>
<blockquote>
<p>35. Individual interveners’ views were divided among mandatory receipt, an opt-in mechanism, and
    the choice to opt out. Technology solutions providers indicated mixed support between
    mandatory reception and the choice to opt out. EMOs strongly supported mandatory receipt.</p>
<p>36. The OPC submitted that many people consider their mobile devices to be private and personal,
    and that some individuals could consider emergency alerts to be intrusive. It recommended
    that the Commission review how opt-out mechanisms have been implemented in the United States
    and other jurisdictions, and whether the ability to opt out has had a significant negative
    effect on alerting individuals in an emergency situation. It submitted that individuals should
    be allowed to opt out if the effect is found to be minimal.</p>
<p>39. Some WSPs provided insight on past experiences regarding the distribution of AMBER Alerts over
    their parent BDUs. For example, in March 2016, the Ontario Provincial Police issued an AMBER
    Alert, which was distributed by BDUs. Many television viewers were upset by the interruption
    of their television viewing and contacted their BDU customer service centres and, in some
    cases, 9-1-1 to complain.</p>
</blockquote>
<p>And finally, in a section titled "Commission’s analysis and determinations", a decision was made:</p>
<blockquote>
<p>41. Although some interveners suggested modifying the BI list, there was no consensus on which
    specific categories should be added or removed.</p>
<p>42. However, the question in this proceeding is not whether the BI list used in the broadcasting
    context should be changed, but whether the same or a different approach should be taken with
    respect to emergency alert messages sent to mobile devices compared to those sent via
    broadcasting emergency alerting. The current BI list is designed to protect against threats to
    life and property. It is therefore important to promote consistency between broadcasting and
    wireless emergency alerts so that Canadians can receive the same alerts regardless of
    transmission medium.</p>
<p>43. In light of the above, the Commission mandates the reception of emergency alert messages on
    mobile devices, based on the BI list developed by SOREM, as amended from time to time.</p>
</blockquote>
<p>This seems to say that the list of what alerts exist and their priority is managed by SOREM.</p>
<p>To back this up, the CRTC's <a href="https://crtc.gc.ca/eng/television/services/alert.htm">Emergency Alerts and the National Public Alerting System</a> page has a section titled "Consistent appearance and sound of alerts" with the
quote:</p>
<blockquote>
<p>The visual appearance, sound, content, and other aspects of emergency alerts are guided by the
Senior Officials Responsible for Emergency Management. This federal, provincial and territorial
body works to harmonize and improve emergency practices across the country.</p>
</blockquote>
<p>That section also includes a link to the <a href="https://www.publicsafety.gc.ca/cnt/mrgnc-mngmnt/mrgnc-prprdnss/npas/clf-lng-20-en.aspx">National Public Alerting System's Common Look and Feel
Guidance</a> which has some more information in it:</p>
<p>From the <a href="https://www.publicsafety.gc.ca/cnt/mrgnc-mngmnt/mrgnc-prprdnss/npas/clf-lng-20-en.aspx#s73">7.3 SOREM Public Alerting Layer</a> section:</p>
<blockquote>
<p>The SOREM Public Alerting Layer establishes parameters that are referred to by the CLF. The
current version of the specification can be found in Appendix B.</p>
</blockquote>
<p>From the <a href="https://www.publicsafety.gc.ca/cnt/mrgnc-mngmnt/mrgnc-prprdnss/npas/clf-lng-20-en.aspx#sb">APPENDIX B – SOREM Public Alerting Layer</a> section:</p>
<blockquote>
<p>The SOREM Public Alerting Layer establishes a number of CAP <parameter>s which are used to support
the public alerting community in Canada. In a separate document, SOREM maintains the “Broadcast
Immediate Events List”, which works in conjunction with this layer. The current version of this
list is available at <a href="https://alerts.pelmorex.com/highpriorityalerts/">https://alerts.pelmorex.com/highpriorityalerts/</a></p>
</blockquote>
<p>That link goes to a page that doesn't exist, but by visiting <a href="https://alerts.pelmorex.com">https://alerts.pelmorex.com</a> directly
and looking around, it looks like it should point to: <a href="https://alerts.pelmorex.com/wp-content/uploads/2022/07/List-of-Event-Codes-for-Broadcast-Immediate-Alerts_version-2.1.pdf">List of Event Codes for Broadcast
Immediate Alerts (version 2.1)</a> (last updated 2022-05-25).</p>
<p>This document contains a table titled "EVENT CODE DESCRIPTIONS FOR EMERGENCY PUBLIC ALERT BROADCAST
IMMEDIATE EVENTS" that defines what codes map to what alert severity. For example, the reason why an
AMBER alert is sent at the highest level is because of this entry:</p>
<blockquote>
<p><strong>Event Code</strong>: amber <br>
<strong>CAP Code for Urgency</strong>: Immediate <br>
<strong>CAP Code for Severity</strong>: Severe or Extreme <br>
<strong>CAP Code for Certainty</strong>: Observed <br>
<strong>Description</strong>: Amber Alert:
    Issued by police services when a child has been abducted and it is believed that his/her life
    is in grave danger. An Amber Alert provides the public with immediate and up-to-date
    information about a child abduction and solicits the public's help in the safe and swift
    return of the child.</p>
</blockquote>
<p>Where the following definitions for the CAP codes are used:</p>
<ul>
<li>"Immediate" - Responsive action SHOULD be taken immediately</li>
<li>"Extreme" - Extraordinary threat to life</li>
<li>"Severe" - Significant threat to life</li>
<li>"Observed" - Determined to have occurred or to be ongoing</li>
</ul>
<p>This is where the "everything at the highest alert level" issue comes from. Aside from
<code>testMessage</code>, literally every other event code on this list has the same Immediate + Severe/Extreme
classification. This includes everything from <code>silver</code> (<em>"a missing, wandering older adult who may
be suffering from a documented cognitive disability or degenerative memory disorder"</em>) to <code>meteor</code>
(<em>"A natural object of extraterrestrial origin [...] hits the ground with the potential for
catastrophic damage."</em>) </p>
<h3>Summary</h3>
<p>The CRTC requires that Wireless Service Providers (WSPs) implement the alerts as defined by SOREM.
SOREM's list of alerts defines an AMBER alert as requiring the same amount of urgency and disruption
as a planet-killing meteor dropping from the sky.</p>
<p>This seems to be by design, but if not, SOREM is the organization that would need to fix it. As an
aside, it seems like the CRTC wouldn't even have to get involved as the policy just defers to the
<em>"BI list developed by SOREM, as amended from time to time"</em> which seems pretty loose. Maybe I'm
missing something though.</p>
<p>I didn't find anything that specified any details about how wide the affected range for these alerts
should or should not be. It seems like that's left up to the organization issuing the alert.</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/diagnosing-periodic-high-ping-times-on-macos.html">Diagnosing periodic high ping times on macOS</a></h1>
  </div>
  <div class="article_text">
    <h2>Background</h2>
<p>Up until a few months ago, my home network setup was pretty terrible. The entire house ran off the
WiFi provided by an <a href="https://openwrt.org/">OpenWRT</a>-powered <a href="https://www.tp-link.com/us/products/details/TL-WDR3600.html">TP-Link WDR3600</a> from 2013 in the far corner of the
house. So when I fired up a game on my laptop via <a href="https://store.steampowered.com/streaming/">Steam in-home streaming</a> and got unplayable lag
and stuttering, I just figured that the issue was the network and left it at that. After all, the
gaming PC was connected via WiFI from the opposite corner of the house with no shortage of walls in
between.</p>
<p>In November 2018, I finally got serious about the network upgrade I had been planning. I'll probably
do a more in-depth post about this at some point, but to make a long story short: Most things are
wired and what isn't is connected via a modern, centrally-located access point. Performance is
noticeably better in general and <em>amazingly</em> better for high-bandwidth tasks like transferring
files.</p>
<p>So when I excitedly fired up the same game on my laptop, I was pretty surprised that it was still
unplayable. At this point I should clarify that the game was not something that requires a CRT and
wired controller for super-low response times. So when I say unplayable, I mean legitimately
unplayable. I'm talking periodic lag spikes that caused the video to drop a few seconds or more
behind the inputs. Even turn-based games would have issues with the amount of lag.</p>
<h2>Narrowing the scope</h2>
<p>To make sure it wasn't an issue with the streaming software, the gaming PC, or the network, I used
<code>ping</code> to test the latency to the gateway from a few hosts. All the computers <em>except</em> my laptop had
normal ping times. Running it on my laptop looked like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>ping<span class="w"> </span>pfsense.lan<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>&gt;<span class="o">(</span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;time=\K\S*&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>spark<span class="o">)</span>
PING<span class="w"> </span>pfsense.lan<span class="w"> </span><span class="o">(</span><span class="m">192</span>.168.1.1<span class="o">)</span>:<span class="w"> </span><span class="m">56</span><span class="w"> </span>data<span class="w"> </span>bytes
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">0</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.574<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.996<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.568<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">92</span>.153<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">39</span>.079<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">5</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">14</span>.307<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">6</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.570<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">7</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.636<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">8</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.698<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">9</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.568<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">10</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.550<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">11</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.106<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">12</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.832<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">13</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.816<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">14</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">36</span>.598<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">15</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">42</span>.863<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">16</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">20</span>.747<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">17</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">3</span>.112<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">18</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.695<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">19</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.795<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">20</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.504<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">21</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.644<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">22</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.732<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">23</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.581<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">24</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.794<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">25</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">33</span>.367<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">26</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">124</span>.282<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">27</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">97</span>.719<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">28</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">76</span>.501<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">29</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.734<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">30</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.622<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">31</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.758<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">32</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.578<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">33</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.527<span class="w"> </span>ms
<span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.1:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">34</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">64</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">1</span>.017<span class="w"> </span>ms
^C
<span class="w"> </span>▁▁▁▆▃▁▁▁▁▁▁▁▁▁▃▃▂▁▁▁▁▁▁▁▁▂█▆▅▁▁▁▁▁▁
</code></pre></div></td></tr></table></div>

<p>(sweet graph at the end courtesy of <a href="https://github.com/holman/spark/wiki/Wicked-Cool-Usage#visualize-ping-times-jnovinger">spark</a>)</p>
<p>Notice the periodic spikes. Clearly there's something going on with the network connection on my
laptop. Connecting via a wired connection and running it again confirmed that it was only happening
on WiFi.</p>
<h2>WiFi debugging</h2>
<p>Now that I had narrowed the issue down to an issue with the WiFi, I could start trying to debug it.</p>
<p>After coming across <a href="https://superuser.com/questions/585473/debugging-osx-airport-wifi-connection/735572#735572">this very helpful post</a> explaining how, I enabled WiFi debug logging by running:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>sudo<span class="w"> </span>/System/Library/PrivateFrameworks/Apple80211.framework/Versions/A/Resources/airport<span class="w"> </span>en0<span class="w"> </span>debug<span class="w"> </span>+AllUserland
</code></pre></div></td></tr></table></div>

<p>(remember to turn this off after, <code>airport</code> is pretty chatty with debug logs enabled)</p>
<p>I then watched the wifi log (<code>sudo tail -f /var/log/wifi.log</code>) as I ran the same <code>ping</code> command.
Whenever I saw ping times spike, I also saw the following entries in the WiFi log:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code>Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.764<span class="w"> </span>IPC:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>ADDED<span class="w"> </span>XPC<span class="w"> </span>CLIENT<span class="w"> </span>CONNECTION<span class="w"> </span><span class="o">[</span>QSyncthingTray<span class="w"> </span><span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>,<span class="w"> </span><span class="nv">euid</span><span class="o">=</span><span class="m">501</span>,<span class="w"> </span><span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.765<span class="w"> </span>Info:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>SCAN<span class="w"> </span>request<span class="w"> </span>received<span class="w"> </span>from<span class="w"> </span>pid<span class="w"> </span><span class="m">14397</span><span class="w"> </span><span class="o">(</span>QSyncthingTray<span class="o">)</span><span class="w"> </span>with<span class="w"> </span>priority<span class="w"> </span><span class="m">0</span>
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>Scan:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>on<span class="w"> </span>channel<span class="w"> </span><span class="m">1</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>require<span class="w"> </span>a<span class="w"> </span>live<span class="w"> </span>scan
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>Scan:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>on<span class="w"> </span>channel<span class="w"> </span><span class="m">2</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>require<span class="w"> </span>a<span class="w"> </span>live<span class="w"> </span>scan
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>Scan:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>on<span class="w"> </span>channel<span class="w"> </span><span class="m">3</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>require<span class="w"> </span>a<span class="w"> </span>live<span class="w"> </span>scan
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>Scan:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>on<span class="w"> </span>channel<span class="w"> </span><span class="m">4</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>require<span class="w"> </span>a<span class="w"> </span>live<span class="w"> </span>scan
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>Scan:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>on<span class="w"> </span>channel<span class="w"> </span><span class="m">5</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>require<span class="w"> </span>a<span class="w"> </span>live<span class="w"> </span>scan
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>Scan:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>on<span class="w"> </span>channel<span class="w"> </span><span class="m">6</span><span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>require<span class="w"> </span>a<span class="w"> </span>live<span class="w"> </span>scan
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>Scan:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>does<span class="w"> </span>not<span class="w"> </span>require<span class="w"> </span>a<span class="w"> </span>live<span class="w"> </span>scan
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span>AutoJoin:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>Successful<span class="w"> </span>cache-assisted<span class="w"> </span>scan<span class="w"> </span>request<span class="w"> </span><span class="k">for</span><span class="w"> </span>QSyncthingTray<span class="w"> </span>with<span class="w"> </span>channels<span class="w"> </span><span class="o">{(</span>
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w">     </span>&lt;CWChannel:<span class="w"> </span>0x7f9073514e70&gt;<span class="w"> </span><span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">1</span><span class="o">(</span>2GHz<span class="o">)</span>,<span class="w"> </span><span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>,<span class="w"> </span>active<span class="o">]</span>,
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w">     </span>&lt;CWChannel:<span class="w"> </span>0x7f90735507b0&gt;<span class="w"> </span><span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">2</span><span class="o">(</span>2GHz<span class="o">)</span>,<span class="w"> </span><span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>,<span class="w"> </span>active<span class="o">]</span>,
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w">     </span>&lt;CWChannel:<span class="w"> </span>0x7f9073526370&gt;<span class="w"> </span><span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">3</span><span class="o">(</span>2GHz<span class="o">)</span>,<span class="w"> </span><span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>,<span class="w"> </span>active<span class="o">]</span>,
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w">     </span>&lt;CWChannel:<span class="w"> </span>0x7f9073526420&gt;<span class="w"> </span><span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">4</span><span class="o">(</span>2GHz<span class="o">)</span>,<span class="w"> </span><span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>,<span class="w"> </span>active<span class="o">]</span>,
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w">     </span>&lt;CWChannel:<span class="w"> </span>0x7f907354ddb0&gt;<span class="w"> </span><span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">5</span><span class="o">(</span>2GHz<span class="o">)</span>,<span class="w"> </span><span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>,<span class="w"> </span>active<span class="o">]</span>,
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w">     </span>&lt;CWChannel:<span class="w"> </span>0x7f907354c6c0&gt;<span class="w"> </span><span class="o">[</span><span class="nv">channelNumber</span><span class="o">=</span><span class="m">6</span><span class="o">(</span>2GHz<span class="o">)</span>,<span class="w"> </span><span class="nv">channelWidth</span><span class="o">={</span>20MHz<span class="o">}</span>,<span class="w"> </span>active<span class="o">]</span>
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.766<span class="w"> </span><span class="o">)}</span><span class="w"> </span>took<span class="w"> </span><span class="m">0</span>.0007<span class="w"> </span>seconds,<span class="w"> </span>returned<span class="w"> </span><span class="m">5</span><span class="w"> </span>results
&lt;<span class="w"> </span>insert<span class="w"> </span>logs<span class="w"> </span>like<span class="w"> </span>above<span class="w"> </span><span class="k">for</span><span class="w"> </span>all<span class="w"> </span>channels<span class="w"> </span>all<span class="w"> </span>the<span class="w"> </span>way<span class="w"> </span>up<span class="w"> </span>to<span class="w"> </span><span class="m">144</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>batches<span class="w"> </span>of<span class="w"> </span><span class="m">6</span><span class="w"> </span>&gt;
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:33.779<span class="w"> </span>IPC:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>INVALIDATED<span class="w"> </span>XPC<span class="w"> </span>CLIENT<span class="w"> </span>CONNECTION<span class="w"> </span><span class="o">[</span>QSyncthingTray<span class="w"> </span><span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>,<span class="w"> </span><span class="nv">euid</span><span class="o">=</span><span class="m">501</span>,<span class="w"> </span><span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
&lt;<span class="w"> </span><span class="m">10</span><span class="w"> </span>seconds<span class="w"> </span>pass&gt;
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:43.847<span class="w"> </span>IPC:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>ADDED<span class="w"> </span>XPC<span class="w"> </span>CLIENT<span class="w"> </span>CONNECTION<span class="w"> </span><span class="o">[</span>QSyncthingTray<span class="w"> </span><span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>,<span class="w"> </span><span class="nv">euid</span><span class="o">=</span><span class="m">501</span>,<span class="w"> </span><span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
&lt;<span class="w"> </span>same<span class="w"> </span>scanning<span class="w"> </span>logs<span class="w"> </span>as<span class="w"> </span>above<span class="w"> </span>&gt;
Tue<span class="w"> </span>Nov<span class="w"> </span><span class="m">27</span><span class="w"> </span><span class="m">02</span>:01:46.741<span class="w"> </span>IPC:<span class="w"> </span>&lt;airportd<span class="o">[</span><span class="m">68</span><span class="o">]</span>&gt;<span class="w"> </span>INVALIDATED<span class="w"> </span>XPC<span class="w"> </span>CLIENT<span class="w"> </span>CONNECTION<span class="w"> </span><span class="o">[</span>QSyncthingTray<span class="w"> </span><span class="o">(</span><span class="nv">pid</span><span class="o">=</span><span class="m">14397</span>,<span class="w"> </span><span class="nv">euid</span><span class="o">=</span><span class="m">501</span>,<span class="w"> </span><span class="nv">egid</span><span class="o">=</span><span class="m">20</span><span class="o">)]</span>
&lt;<span class="w"> </span>...<span class="w"> </span>and<span class="w"> </span>repeat<span class="w"> </span>&gt;
</code></pre></div></td></tr></table></div>

<p>This pretty clearly indicates that the <a href="https://github.com/sieren/QSyncthingTray">QSyncthingTray</a> application (a tray icon to monitor
<a href="https://syncthing.net/">Syncthing</a>) was periodically requesting WiFi scans which, in turn, caused the bursts of latency.
After quitting the application and running <code>ping</code> again, the times were all &lt;2ms, even after running
for a few minutes. Also, when I started up the game again to test it, the lag was completely gone!</p>
<h2>Digging deeper</h2>
<p>Since QSyncthingTray is open source, I filed a <a href="https://github.com/sieren/QSyncthingTray/issues/237">bug report</a> on the project and dug into the code
to see if I could pinpoint the issue. After finding nothing out of the ordinary and doing a bunch of
searching the internet, it turns out that it's not an issue with QSyncthingTray at all, but with
<a href="https://www.qt.io">Qt</a>, a cross-platform SDK that QSyncthingTray and many other programs use. Some classmates and I
actually used it to make a game called <a href="https://github.com/pR0Ps/ParticleStorm">ParticleStorm</a> back in university.</p>
<p>There are open bug reports against this issue from <a href="https://bugreports.qt.io/browse/QTBUG-34641">2013</a>, <a href="https://bugreports.qt.io/browse/QTBUG-40332">2014</a>, and <a href="https://bugreports.qt.io/browse/QTBUG-46015">2015</a>. Additionally,
there are loads of <a href="https://lostdomain.org/2017/06/17/qt-qnetworkaccessmanager-causing-latency-spikes-on-wifi/">blog</a> <a href="https://justus.berlin/2016/04/reducing-cpu-load-and-energy-consumption-of-texstudio-on-the-mac/">posts</a> and <a href="https://github.com/qbittorrent/qBittorrent/commit/c2b6e1ce1aa402b143d0154748c518a87bc6424a">per</a>-<a href="https://github.com/sqlitebrowser/sqlitebrowser/commit/73946400c32d1f7cfcd4672ab0ab3f563eb84f4e">program</a> <a href="https://github.com/KDE/krita/commit/19ba224692a52b1d5799fda308bed4b02ff38f7a">workarounds</a>. It's a little
disappointing that just running a network-enabled Qt application can seriously disrupt real-time
applications on the same system. Granted, I have no knowledge of the complexities of this issue, but
at the very least it seems <a href="https://doc.qt.io/qt-5/qnetworkconfigurationmanager.html">the documentation</a> could be clearer on the issue so developers stop
<a href="https://www.reddit.com/r/krita/comments/9xea9b/this_is_gonna_sound_crazy_but_is_krita/e9tfify/">getting surprised by it</a>.</p>
<p>Anyway, the "fix" is to set <code>QT_BEARER_POLL_TIMEOUT=-1</code> as an environment variable on your system.
Honestly, I've just stopped using QSyncthingTray instead. Not that it's not useful, I just realized
that I didn't really need it. Syncthing works well enough that I don't find myself ever worrying
about it. If a Qt application ever becomes an essential part of my setup I guess I'll have to
revisit this.</p>
<h2>Takeaways</h2>
<ol>
<li>
<p>When macOS scans for networks (as it does when requested by an application, when you click the WiFi
   icon, or when you request your location) it causes high ping times and dropped packets. According to
   bug reports, scanning for WiFi networks on other OS's causes the same issues. This is something I
   didn't really expect, but good to know going forward.</p>
</li>
<li>
<p>Qt has a bug where instantiating a <code>QNetworkConfigurationManager</code> causes it to scan for WiFi
   networks every 10 seconds by default. Some applications set the <code>QT_BEARER_POLL_TIMEOUT</code> environment
   variable themselves to disable this behaviour, but the majority probably have no idea that it's even
   an issue until a user reports it.</p>
</li>
</ol>
<p>So if you're seeing regular latency spikes, audit what programs you have running. Specifically look
for programs built with Qt. Setting the <code>QT_BEARER_POLL_TIMEOUT</code> environment variable to <code>-1</code> can
help with these. Applications that use your location <a href="https://apple.stackexchange.com/questions/263638/macbook-pro-experiencing-ping-spikes-to-local-router/317431#317431">could also be the culprit</a>. Who knew keeping
your ping down to an acceptable level was such a minefield...</p>
  </div>
</article>
<hr />
<article>
  <div class="article_title">
    <h1><a href="../blog/proxied-access-to-namecheap-dns.html">Proxied access to the Namecheap DNS API</a></h1>
  </div>
  <div class="article_text">
    <h2>Background</h2>
<p>Both this site and my home server use HTTPS certificates provided by <a href="https://letsencrypt.org">Let's Encrypt</a>.
<a href="../blog/adding-https-support.html">Previously</a> I was using the <code>http-01</code> challenge method, but once <a href="https://community.letsencrypt.org/t/acme-v2-and-wildcard-certificate-support-is-live/55579">wildcard
certificates became available</a>, I decided to switch to the <code>dns-01</code> method for simplicity.</p>
<p>My domains are currently registered through <a href="https://www.namecheap.com/">Namecheap</a> which provides an API for modifying DNS
records. The only catch is that it can only be accessed via manually-whitelisted IP addresses.
Because the server I'm trying to access the API from is assigned a dynamic IP, this restriction was
a bit of an issue.</p>
<p>Back in November when I initially made the switch to the DNS-based challenge, I set it up the easy
way: I manually added my current IP to the whitelist, added a TODO entry to fix it somehow, and set
a reminder scheduled for the week before the cert would expire telling me to update the IP
whitelist. Fast-forward to today when I was reminded to update my IP whitelist. Instead of
continuing to kick the can down the road, I decided to actually fix the issue.</p>
<h2>Setting up a temporary proxy</h2>
<p>My home server is connected to the internet though a normal residential connection which is assigned
a dynamic IP address. However, the server that I run this website on is configured with a static IP
since it's a hosted <a href="https://en.wikipedia.org/wiki/Virtual_private_server">VPS</a>. By proxying all traffic to the Namecheap API through my VPS, I could
add my VPS's static IP to the whitelist and not have to worry about my home IP changing all the
time.</p>
<p>SSH is perfect tool for this. The <a href="https://www.openssh.com/">OpenSSH client</a> supports port forwarding using the <code>-D</code> flag.
By then setting the <code>HTTP[S]_PROXY</code> environment variables to point to the forwarded port, programs
that support those environment variables will transparently forward all their requests through the
proxy.</p>
<p>After a bunch of research and testing, I came up with the following script to easily set up the
temporary proxy:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Source this file to automatically setup and teardown an HTTP* proxy through cmetcalfe.ca</span>
<span class="c1"># Use the PROXY_PORT and PROXY_DEST environment variables to customize the proxy</span>

<span class="nv">PROXY_PORT</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROXY_PORT</span><span class="k">:-</span><span class="nv">11111</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">PROXY_DEST</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">PROXY_DEST</span><span class="k">:-</span><span class="p">&lt;username&gt;@cmetcalfe.ca</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nv">PID</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$$</span><span class="s2">&quot;</span>

<span class="c1"># Teardown the SSH connection when the script exits</span>
<span class="nb">trap</span><span class="w"> </span><span class="s1">&#39;ssh -q -S &quot;.ctrl-socket-$PID&quot; -O exit &quot;$PROXY_DEST&quot;&#39;</span><span class="w"> </span>EXIT

<span class="c1"># Set up an SSH tunnel and wait for the port to be forwarded before continuing</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>ssh<span class="w"> </span>-o<span class="w"> </span><span class="nv">ExitOnForwardFailure</span><span class="o">=</span>yes<span class="w"> </span>-M<span class="w"> </span>-S<span class="w"> </span><span class="s2">&quot;.ctrl-socket-</span><span class="nv">$PID</span><span class="s2">&quot;</span><span class="w"> </span>-f<span class="w"> </span>-N<span class="w"> </span>-D<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROXY_PORT</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROXY_DEST</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failed to open SSH tunnel, exiting&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Set environment variables to redirect HTTP* traffic through the proxy</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HTTP_PROXY</span><span class="o">=</span><span class="s2">&quot;socks5://127.0.0.1:</span><span class="nv">$PROXY_PORT</span><span class="s2">&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">HTTPS_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$HTTP_PROXY</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>

<p>This script is saved as <code>~/.config/tempproxy.rc</code> and can be sourced to automatically set up a proxy
session and have it be torn down when the script exits.</p>
<p>You'll want to use key-based authentication with an unencrypted private key so that you don't need
to type anything to initiate the SSH session. For this reason you'll probably want to create a
limited user on the target system that can only really do port forwarding. There's a good post on
this <a href="https://askubuntu.com/questions/48129/how-to-create-a-restricted-ssh-user-for-port-forwarding/50000#50000">here</a>.</p>
<h2>Talking to the API through the proxy</h2>
<p>To allow programs that use the <code>tempproxy.rc</code> script to talk to the Namecheap API, the IP address of
the VPS was added to the whitelist. Now that the proxying issue was taken care of, I just needed
to wire up the actual certificate renewal process to use it.</p>
<p>The tool I'm using to talk to the Namecheap DNS API is <a href="https://github.com/AnalogJ/lexicon">lexicon</a>. It can handle manipulating the
DNS records of a ton of providers and integrates really nicely with my <a href="https://en.wikipedia.org/wiki/Automated_Certificate_Management_Environment">ACME</a> client of choice,
<a href="https://github.com/lukas2511/dehydrated">dehydrated</a>. Also, because it's using the <a href="https://github.com/Bemmu/PyNamecheap">PyNamecheap</a> Python library, which in turn uses
<a href="http://python-requests.org">requests</a> under the hood, it will <a href="http://docs.python-requests.org/en/master/user/advanced/#proxies">automatically use the <code>HTTP*_PROXY</code> environment
variables</a> when making requests.</p>
<p>The only tricky bit is that the base install of <code>lexicon</code> won't automatically pull in the packages
required for accessing the Namecheap API. Likewise, <code>requests</code> won't install packages to support
SOCKS proxies. To install all the required packages you'll need to run a command like:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span><span class="s1">&#39;requests[socks]&#39;</span><span class="w"> </span><span class="s1">&#39;dns-lexicon[namecheap]&#39;</span>
</code></pre></div></td></tr></table></div>

<p>Since lexicon can use environment variables as configuration, I created another small source-able
file at <code>~/.config/lexicon.rc</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Sets environment variables for accessing the Namecheap API</span>

<span class="c1"># Turn on API access and get an API token here:</span>
<span class="c1"># https://ap.www.namecheap.com/settings/tools/apiaccess/</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">PROVIDER</span><span class="o">=</span>namecheap
<span class="nb">export</span><span class="w"> </span><span class="nv">LEXICON_NAMECHEAP_USERNAME</span><span class="o">=</span>&lt;username&gt;
<span class="nb">export</span><span class="w"> </span><span class="nv">LEXICON_NAMECHEAP_TOKEN</span><span class="o">=</span>&lt;api<span class="w"> </span>token&gt;
</code></pre></div></td></tr></table></div>

<p>With that in place, the existing automation script that I had previously set up when I switched to
using the <code>dns-01</code> challenge just needed some minor tweaks to source the two new files. I've
provided the script below, along with some other useful ones that use the DNS API.</p>
<h2>Scripts</h2>
<h3><code>do-letsencrypt.sh</code></h3>
<p>This is the main script that handles all the domain renewals. It's called via <code>cron</code> on the first
of every month.</p>
<p>Fun fact: The previous <code>http-01</code> version of this script was a mess - it involved juggling <code>nginx</code>
configurations with symlinks, manually opening up the <code>.well-known/acme-challenge</code> endpoint, and
some other terrible hacks. This version is <em>much</em> nicer.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Generate/renew Let&#39;s Encrypt certificates using dehydrated and lexicon</span>

<span class="nb">set</span><span class="w"> </span>-e

<span class="c1"># Set configuration variables and setup the proxy</span>
<span class="nb">source</span><span class="w"> </span>~/.config/lexicon.rc
<span class="nb">source</span><span class="w"> </span>~/.config/tempproxy.rc

<span class="nb">cd</span><span class="w"> </span>/etc/nginx/ssl

<span class="c1"># Update the certs.</span>
<span class="c1"># Hook script copied verbatim from</span>
<span class="c1"># https://github.com/AnalogJ/lexicon/blob/master/examples/dehydrated.default.sh</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>dehydrated<span class="w"> </span>--accept-terms<span class="w"> </span>--cron<span class="w"> </span>--challenge<span class="w"> </span>dns-01<span class="w"> </span>--hook<span class="w"> </span>dehydrated.default.sh<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failed to renew certificates&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>

<span class="c1"># Reload the nginx config if it&#39;s currently running</span>
<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>systemctl<span class="w"> </span>is-active<span class="w"> </span>nginx.service<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;nginx isn&#39;t running, not reloading it&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<span class="k">fi</span>

<span class="k">if</span><span class="w"> </span>!<span class="w"> </span>systemctl<span class="w"> </span>reload<span class="w"> </span>nginx.service<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span>systemctl<span class="w"> </span>status<span class="w"> </span>nginx.service
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failed to reload nginx config, check the error log&quot;</span>
<span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="k">fi</span>
</code></pre></div></td></tr></table></div>

<h3><code>dns.sh</code></h3>
<p>This one is really simple - it just augments the normal lexicon CLI interface with the proxy and
configuration variables.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># A simple wrapper around lexicon.</span>
<span class="c1"># Sets up the proxy and configuration, then passes all the arguments to the configured provider</span>

<span class="nb">source</span><span class="w"> </span>~/.config/lexicon.rc
<span class="nb">source</span><span class="w"> </span>~/.config/tempproxy.rc
lexicon<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code>$<span class="w"> </span>./dns.sh<span class="w"> </span>list<span class="w"> </span>cmetcalfe.ca<span class="w"> </span>A
ID<span class="w">       </span>TYPE<span class="w"> </span>NAME<span class="w">             </span>CONTENT<span class="w">         </span>TTL
--------<span class="w"> </span>----<span class="w"> </span>----------------<span class="w"> </span>---------------<span class="w"> </span>----
xxxxxxxx<span class="w"> </span>A<span class="w">    </span>@.cmetcalfe.ca<span class="w">   </span>xxx.xxx.xxx.xxx<span class="w"> </span><span class="m">1800</span>
xxxxxxxx<span class="w"> </span>A<span class="w">    </span>www.cmetcalfe.ca<span class="w"> </span>xxx.xxx.xxx.xxx<span class="w"> </span><span class="m">1800</span>
</code></pre></div></td></tr></table></div>

<h3><code>dns-update.sh</code></h3>
<p>An updated version of my <a href="../blog/dynamic-dns-client-for-namecheap.html">previous script</a> that uses the API instead of the
<a href="https://www.namecheap.com/support/knowledgebase/article.aspx/29/11/how-do-i-use-a-browser-to-dynamically-update-the-hosts-ip">DynamicDNS service Namecheap provides</a>. Called via <code>cron</code> every 30 minutes.</p>
<div class="admonition update">
<p class="admonition-title">Update</p>
<p>A previous version of this script didn't try to delete the DNS entry before setting the new one,
resulting in multiple IPs being set as the same <code>A</code> record.</p>
<p>This is because the <a href="https://github.com/AnalogJ/lexicon/blob/1feca5ead36cbf85ad92676dc853045e2c646097/lexicon/providers/namecheap.py#L233">update function of the Namecheap plugin for lexicon</a> is implemented as a
2-step delete and add. When it tries to delete the old record, it looks for one with the same
content as the old one. This means that if you update a record with a new IP, it doesn't find
the old record to delete first, leaving you with all of your old IPs set as individual A
records.</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/bin/sh</span>
<span class="c1"># Check the server&#39;s current IP against the IP listed in its DNS entry.</span>
<span class="c1"># Set the current IP if they differ.</span>

<span class="nb">set</span><span class="w"> </span>-e

resolve<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="nv">line</span><span class="o">=</span><span class="k">$(</span>drill<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="w"> </span>@resolver1.opendns.com<span class="w"> </span><span class="m">2</span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;/;;.*$/d;/^\s*$/d&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span><span class="k">)</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-f5
<span class="o">}</span>

<span class="nv">dns</span><span class="o">=</span><span class="k">$(</span>resolve<span class="w"> </span>&lt;subdomain&gt;.cmetcalfe.ca<span class="k">)</span>
<span class="nv">curr</span><span class="o">=</span><span class="k">$(</span>resolve<span class="w"> </span>myip.opendns.com<span class="k">)</span>
<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$dns</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$curr</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span>~/.config/lexicon.rc
<span class="w">    </span><span class="nb">source</span><span class="w"> </span>~/.config/tempproxy.rc
<span class="w">    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>lexicon<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span><span class="w"> </span>delete<span class="w"> </span>cmetcalfe.ca<span class="w"> </span>A<span class="w"> </span>--name<span class="w"> </span><span class="s2">&quot;&lt;subdomain&gt;.cmetcalfe.ca&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Failed to delete old DNS record, not setting the new one.&quot;</span>
<span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="k">fi</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span>lexicon<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$PROVIDER</span><span class="s2">&quot;</span><span class="w"> </span>update<span class="w"> </span>cmetcalfe.ca<span class="w"> </span>A<span class="w"> </span>--name<span class="w"> </span><span class="s2">&quot;&lt;subdomain&gt;.cmetcalfe.ca&quot;</span><span class="w"> </span>--content<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$curr</span><span class="s2">&quot;</span><span class="w"> </span>--ttl<span class="o">=</span><span class="m">900</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Server DNS record updated (</span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Server DNS record update FAILED (tried </span><span class="nv">$dns</span><span class="s2"> -&gt; </span><span class="nv">$curr</span><span class="s2">)&quot;</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">fi</span>
</code></pre></div></td></tr></table></div>
  </div>
</article>

<footer>
<div id="paginator">
  <span id="left">
      <a href="../blog/index.html"><i class="fa fa-arrow-circle-left"></i> Prev</a>
  </span>
  <span id="right">
      <a href="../blog/index3.html">Next <i class="fa fa-arrow-circle-right"></i></a>
  </span>
  <div>
      <a href="../blog/index.html"> 1 </a>
      <a href="../blog/index2.html">[2]</a>
      <a href="../blog/index3.html"> 3 </a>
      <a href="../blog/index4.html"> 4 </a>
      <a href="../blog/index5.html"> 5 </a>
      <a href="../blog/index6.html"> 6 </a>
      <a href="../blog/index7.html"> 7 </a>
      <a href="../blog/index8.html"> 8 </a>
      <a href="../blog/index9.html"> 9 </a>
      <a href="../blog/index10.html"> 10 </a>
      <a href="../blog/index11.html"> 11 </a>
      <a href="../blog/index12.html"> 12 </a>
      <a href="../blog/index13.html"> 13 </a>
  </div>
</div>
</footer>

    <div id="ending_message">
        <p>&copy; Carey Metcalfe. Built using <a href="http://getpelican.com">Pelican</a>. Theme is <a href="https://github.com/pR0Ps/pelican-subtle">subtle</a> by <a href="http://cmetcalfe.ca">Carey Metcalfe</a>. Based on <a href="https://github.com/giulivo/pelican-svbhack">svbhack</a> by Giulio Fidente.</p>
    </div>
  </main>

  <script type="text/javascript">
    window.addEventListener('load', skipHeader)
  </script>

  <script type="text/javascript">
  window.addEventListener('load', unmangleEmail)
  </script>
</body>
</html>